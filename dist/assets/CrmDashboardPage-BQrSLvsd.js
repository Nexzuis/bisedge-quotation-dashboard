import{j as e,m as l,u as $,a as L,b as D}from"./vendor-motion-BTi7gxEc.js";import{u as p,r as u}from"./vendor-react-CUuYCEpB.js";import{al as x,am as m,_ as h,an as O,a as C,D as B,F as S,Z as E,ai as R,ao as q,ap as F,aq as H,ar as U,as as A,at as _,y as Q,w as Y,d as y,u as G,a0 as Z,au as W}from"./index-BQ8GchdQ.js";import{U as z,P as J,u as K}from"./useActivities-DDyYIwR2.js";import{T as X}from"./trophy-C3NEYXtY.js";import{I as ee}from"./inbox-BOjaHzoY.js";import{A as se,S as T}from"./sticky-note-CoNOk4VY.js";import"./vendor-zustand-DbidXgKt.js";import"./vendor-dexie-TCJlnc2g.js";import"./vendor-pdf-tjGXvEUX.js";import"./vendor-supabase-DxKkahmj.js";function te(){const t=p();return e.jsxs(l.div,{className:"flex flex-wrap gap-3",variants:x,initial:"hidden",animate:"visible",children:[e.jsx(l.div,{variants:m,whileHover:{scale:1.05},whileTap:{scale:.95},children:e.jsx(h,{variant:"primary",icon:z,onClick:()=>t("/customers",{state:{openNewLead:!0}}),children:"New Lead"})}),e.jsx(l.div,{variants:m,whileHover:{scale:1.05},whileTap:{scale:.95},children:e.jsx(h,{variant:"feature",icon:O,onClick:()=>t("/builder"),children:"Quote Builder"})}),e.jsx(l.div,{variants:m,whileHover:{scale:1.05},whileTap:{scale:.95},children:e.jsx(h,{variant:"secondary",icon:C,onClick:()=>t("/customers"),children:"All Customers"})})]})}function ae(t,r=1){const n=$(0),a=L(n,c=>Math.round(c)),[s,i]=u.useState("0"),d=u.useRef(0);return u.useEffect(()=>a.on("change",o=>{i(o.toLocaleString())}),[a]),u.useEffect(()=>{const c=D(n,t,{duration:r,ease:"easeOut"});return d.current=t,c.stop},[t,r,n]),s}function ne({value:t,isCurrency:r}){const n=ae(t);return r?e.jsxs("span",{children:["R ",n]}):e.jsx("span",{children:n})}function ie({metrics:t,userMetrics:r,loading:n}){const a=[{label:"Pipeline Value",value:t?t.totalPipelineValue:0,userValue:r?r.totalPipelineValue:null,icon:B,color:"text-brand-400",bg:"bg-brand-500/10",isCurrency:!0},{label:"Active Leads",value:t?t.activeLeads:0,userValue:r?r.activeLeads:null,icon:C,color:"text-blue-400",bg:"bg-blue-500/10",isCurrency:!1},{label:"Quotes This Month",value:t?t.quotesThisMonth:0,userValue:null,icon:S,color:"text-purple-400",bg:"bg-purple-500/10",isCurrency:!1},{label:"Won This Month",value:t?t.wonThisMonth:0,userValue:r?r.wonThisMonth:null,icon:X,color:"text-green-400",bg:"bg-green-500/10",isCurrency:!1}];return e.jsx(l.div,{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",variants:x,initial:"hidden",animate:"visible",children:a.map(s=>{const i=s.icon;return e.jsx(l.div,{variants:m,whileHover:{scale:1.03,boxShadow:"0 8px 32px rgba(0, 212, 255, 0.12)"},className:"glass rounded-xl p-4 glow-brand-hover cursor-default",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2.5 rounded-lg ${s.bg}`,children:e.jsx(i,{className:`w-5 h-5 ${s.color}`})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-xs text-surface-400",children:s.label}),e.jsx("div",{className:`text-xl font-bold ${n?"animate-pulse text-surface-500":"text-surface-100"}`,children:n?"...":t?e.jsx(ne,{value:s.value,isCurrency:s.isCurrency}):"â€”"}),!n&&s.userValue!==null&&e.jsxs("div",{className:"text-xs text-surface-500 mt-0.5",children:["Yours: ",s.isCurrency?E(s.userValue,!1):s.userValue]})]})]})},s.label)})})}function re({metrics:t}){if(!t)return null;const r=J.filter(s=>s.key!=="won"&&s.key!=="lost"),n=r.reduce((s,i)=>s+(t.countByStage[i.key]||0),0);if(n===0)return e.jsxs("div",{className:"glass rounded-xl p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-300 mb-4",children:"Pipeline Overview"}),e.jsx("div",{className:"text-center text-surface-500 py-4",children:"No active pipeline companies yet"})]});const a={lead:"bg-surface-500",contacted:"bg-blue-500","site-assessment":"bg-purple-500",quoted:"bg-teal-500",negotiation:"bg-amber-500"};return e.jsxs("div",{className:"glass rounded-xl p-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-300 mb-4",children:"Pipeline Overview"}),e.jsx("div",{className:"flex rounded-lg overflow-hidden h-8",children:r.map(s=>{const i=t.countByStage[s.key]||0;if(i===0)return null;const d=i/n*100;return e.jsx(l.div,{initial:{width:0},animate:{width:`${d}%`},transition:{duration:.6,ease:"easeOut"},whileHover:{filter:"brightness(1.2)"},className:`${a[s.key]||"bg-surface-600"} flex items-center justify-center text-xs font-medium text-white min-w-[40px] transition-[filter] duration-200`,title:`${s.label}: ${i}`,children:d>10?i:""},s.key)})}),e.jsx("div",{className:"flex flex-wrap gap-4 mt-3",children:r.map(s=>{const i=t.countByStage[s.key]||0;return e.jsxs(l.div,{className:"flex items-center gap-1.5 text-xs",whileHover:{scale:1.05,opacity:1},style:{opacity:.8},children:[e.jsx("div",{className:`w-2.5 h-2.5 rounded-full ${a[s.key]||"bg-surface-600"}`}),e.jsx("span",{className:"text-surface-400",children:s.label}),e.jsx("span",{className:"text-surface-200 font-medium",children:i})]},s.key)})})]})}const le={note:T,call:U,email:H,meeting:F,"site-visit":q,"quote-created":S,"quote-sent":R,"stage-change":se};function oe(t){const r=Date.now()-new Date(t).getTime(),n=Math.floor(r/6e4);if(n<1)return"just now";if(n<60)return`${n}m ago`;const a=Math.floor(n/60);return a<24?`${a}h ago`:`${Math.floor(a/24)}d ago`}function ce({activities:t,loading:r}){const n=p();return e.jsxs("div",{className:"glass rounded-xl p-5",children:[e.jsx("h3",{className:"text-sm font-semibold text-surface-300 mb-4",children:"Recent Activity"}),r?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(a=>e.jsx("div",{className:"h-10 bg-surface-700/50 rounded animate-pulse"},a))}):t.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-surface-500",children:[e.jsx(l.div,{animate:{y:[-4,4,-4]},transition:{duration:4,repeat:1/0,ease:"easeInOut"},children:e.jsx(ee,{className:"w-10 h-10 text-surface-600 mb-3"})}),e.jsx("div",{className:"text-sm font-medium text-surface-400",children:"No activities yet"}),e.jsx("div",{className:"text-xs text-surface-600 mt-1",children:"Activities will appear here as you interact with customers"})]}):e.jsx(l.div,{className:"space-y-2 max-h-[320px] overflow-y-auto pr-1",variants:x,initial:"hidden",animate:"visible",children:t.map(a=>{const s=le[a.type]||T;return e.jsxs(l.div,{variants:A,whileHover:{y:-2,backgroundColor:"rgba(255,255,255,0.03)"},className:"flex items-start gap-3 p-2 rounded-lg hover:bg-surface-700/30 transition-colors cursor-pointer",onClick:()=>a.companyId&&n(`/customers/${a.companyId}`),children:[e.jsx(l.div,{variants:_,className:"p-1.5 bg-surface-700/50 rounded",children:e.jsx(s,{className:"w-3.5 h-3.5 text-surface-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm text-surface-200 truncate",children:a.title}),a.description&&e.jsx("div",{className:"text-xs text-surface-500 truncate",children:a.description})]}),e.jsx("div",{className:"text-xs text-surface-500 whitespace-nowrap",children:oe(a.createdAt)})]},a.id)})})]})}function de({companies:t,loading:r}){const n=p(),a=Date.now()-336*60*60*1e3,s=t.filter(i=>i.pipelineStage!=="won"&&i.pipelineStage!=="lost"&&new Date(i.updatedAt).getTime()<a);return e.jsxs("div",{className:"glass rounded-xl p-5",children:[e.jsxs("h3",{className:"text-sm font-semibold text-surface-300 mb-4 flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4 text-amber-400"}),"Needs Attention"]}),r?e.jsx("div",{className:"space-y-3",children:[1,2].map(i=>e.jsx("div",{className:"h-10 bg-surface-700/50 rounded animate-pulse"},i))}):s.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-surface-500",children:[e.jsx(l.div,{animate:{y:[-4,4,-4]},transition:{duration:4,repeat:1/0,ease:"easeInOut"},children:e.jsx(Y,{className:"w-10 h-10 text-surface-600 mb-3"})}),e.jsx("div",{className:"text-sm font-medium text-surface-400",children:"All caught up!"}),e.jsx("div",{className:"text-xs text-surface-600 mt-1",children:"No companies need follow-up right now"})]}):e.jsx(l.div,{className:"space-y-2 max-h-[320px] overflow-y-auto pr-1",variants:x,initial:"hidden",animate:"visible",children:s.slice(0,10).map(i=>{const d=Math.floor((Date.now()-new Date(i.updatedAt).getTime())/864e5);return e.jsxs(l.div,{variants:A,whileHover:{y:-2,backgroundColor:"rgba(255,255,255,0.03)"},className:"flex items-center gap-3 p-2 rounded-lg hover:bg-surface-700/30 transition-colors cursor-pointer",onClick:()=>n(`/customers/${i.id}`),children:[e.jsx(l.div,{className:"w-2 h-2 rounded-full bg-amber-400",animate:{scale:[1,1.3,1]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("div",{className:"text-sm text-surface-200 truncate",children:i.name})}),e.jsxs("div",{className:`text-xs font-medium ${d>=21?"bg-gradient-to-r from-amber-400 to-red-400 bg-clip-text text-transparent":"text-amber-400"}`,children:[d,"d no contact"]})]},i.id)})})]})}const ue=["lead","contacted","site-assessment","quoted","negotiation","won","lost"];function me(t,r){const n={},a={};for(const c of ue)n[c]=0,a[c]=0;let s=0,i=0,d=0;for(const c of t){const o=c.pipelineStage;n[o]=(n[o]||0)+1,a[o]=(a[o]||0)+(c.estimatedValue||0),o!=="won"&&o!=="lost"&&(s+=c.estimatedValue||0),o!=="won"&&o!=="lost"&&i++,o==="won"&&c.updatedAt>=r&&d++}return{totalPipelineValue:s,activeLeads:i,wonThisMonth:d,countByStage:n,valueByStage:a}}function xe(){return{getMetrics:u.useCallback(async r=>{const n=await y.companies.toArray(),a=new Date,s=new Date(a.getFullYear(),a.getMonth(),1).toISOString(),i=r?n.filter(o=>o.assignedTo===r):n,d=me(i,s),c=await y.quotes.filter(o=>o.createdAt>=s).count();return{...d,quotesThisMonth:c}},[])}}function Se(){const[t,r]=u.useState(null),[n,a]=u.useState(null),[s,i]=u.useState([]),[d,c]=u.useState([]),[o,v]=u.useState(!0),[g,j]=u.useState(null),{user:b}=G(),{getMetrics:N}=xe(),{getRecent:M}=K(),{listCompanies:k}=Z(),w=async()=>{v(!0),j(null);try{const[f,I,P,V]=await Promise.all([N(),b?N(b.id):Promise.resolve(null),M(15),k()]);r(f),a(I),i(P),c(V)}catch(f){console.error("Failed to load CRM dashboard data:",f),j("Failed to load dashboard data. Please try again.")}finally{v(!1)}};return u.useEffect(()=>{w()},[]),g?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-surface-900 via-surface-800 to-surface-900 flex items-center justify-center p-8",children:e.jsxs("div",{className:"glass rounded-xl p-8 max-w-md text-center",children:[e.jsx("div",{className:"text-red-400 text-lg font-semibold mb-2",children:"Failed to load"}),e.jsx("p",{className:"text-surface-400 mb-4",children:g}),e.jsx("button",{onClick:w,className:"btn btn-primary px-6 py-2",children:"Retry"})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-surface-900 via-surface-800 to-surface-900",children:e.jsxs(l.div,{className:"max-w-7xl mx-auto p-4 space-y-4",variants:x,initial:"hidden",animate:"visible",children:[e.jsx(l.div,{variants:m,children:e.jsx(W,{})}),e.jsx(l.div,{variants:m,children:e.jsx(te,{})}),e.jsx(l.div,{variants:m,children:e.jsx(ie,{metrics:t,userMetrics:n,loading:o})}),e.jsx(l.div,{variants:m,children:e.jsx(re,{metrics:t})}),e.jsxs(l.div,{variants:m,className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsx(ce,{activities:s,loading:o}),e.jsx(de,{companies:d,loading:o})]})]})})}export{Se as default};
