import{j as e,A as Qe,m as Ce}from"./vendor-motion-BTi7gxEc.js";import{u as ze,l as Ge,r as m,f as Ke,j as We,k as z,N as ke}from"./vendor-react-CUuYCEpB.js";import{c as H,u as Y,U as Pe,L as Xe,D as Ye,S as ge,C as Ze,a as es,F as Fe,h as ss,b as oe,d as f,e as je,f as ve,g as ne,T as ce,i as ts,j as as,k as rs,l as ae,t as P,m as ns,n as ls,X as Ue,o as ee,A as is,R as te,P as Se,p as Ne,B as re,q as se,r as de,s as os,v as cs,w as le,x as ye,y as xe,z as _e,E as he,G as Ve,H as ds,I as us,J as Te,K as Ee,M as ms,N as xs,O as fs,Q as ps,V as hs}from"./index-BQ8GchdQ.js";import{A as bs,P as we}from"./plus-Chd8VMT3.js";import{r as gs,u as X,w as js,a as vs}from"./vendor-xlsx-Cig0qvpi.js";import{R as Ns}from"./refresh-cw-BmwvIC3m.js";import"./vendor-zustand-DbidXgKt.js";import"./vendor-dexie-TCJlnc2g.js";import"./vendor-pdf-tjGXvEUX.js";import"./vendor-supabase-DxKkahmj.js";const ys=[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]],ws=H("database",ys);const Cs=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],Ae=H("eye-off",Cs);const ks=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],ie=H("eye",ks);const Ss=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],Ts=H("history",Ss);const Es=[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]],fe=H("key-round",Es);const As=[["path",{d:"M4 5h16",key:"1tepv9"}],["path",{d:"M4 12h16",key:"1lakjw"}],["path",{d:"M4 19h16",key:"1djgab"}]],Ds=H("menu",As);const Rs=[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]],Ms=H("percent",Rs);const Is=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],ue=H("rotate-ccw",Is);const Os=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Be=H("square-pen",Os);const Ls=[["path",{d:"M16 17h6v-6",key:"t6n2it"}],["path",{d:"m22 17-8.5-8.5-5 5L2 7",key:"x473p"}]],De=H("trending-down",Ls);const $s=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],be=H("upload",$s),Ps=()=>{const{user:n,logout:r}=Y(),a=ze(),t=()=>{r(),a("/login")};return e.jsx("div",{className:"bg-surface-700/50 backdrop-blur-xl border-b border-surface-600/50",children:e.jsxs("div",{className:"px-6 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>a("/"),className:"flex items-center gap-2 px-4 py-2 bg-surface-800/40 hover:bg-surface-700/50 border border-surface-700/50 rounded-lg text-surface-100 transition-colors",children:[e.jsx(bs,{className:"w-4 h-4"}),"Back to Dashboard"]}),e.jsx("h1",{className:"text-2xl font-bold text-surface-100",children:"Admin Panel"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-surface-100/80",children:[e.jsx(Pe,{className:"w-5 h-5"}),e.jsx("span",{children:n?.fullName}),e.jsx("span",{className:"text-xs bg-brand-600/30 px-2 py-1 rounded",children:n?.role.toUpperCase()})]}),e.jsxs("button",{onClick:t,className:"flex items-center gap-2 px-4 py-2 bg-red-600/20 hover:bg-red-600/30 border border-red-500/50 rounded-lg text-red-200 transition-colors",children:[e.jsx(Xe,{className:"w-4 h-4"}),"Logout"]})]})]})})},Re=()=>{const{user:n}=Y(),a=n?[{path:"/admin/pricing",label:"Pricing Config",icon:Ye,resource:"admin:pricing"},{path:"/admin/configuration",label:"Configuration Matrices",icon:ge,resource:"admin:catalog"},{path:"/admin/approvals",label:"Approvals",icon:Ze,resource:"approval:approve"},{path:"/admin/users",label:"Users",icon:es,resource:"admin:users"},{path:"/admin/templates",label:"Templates",icon:Fe,resource:"admin:templates"},{path:"/admin/audit",label:"Audit Log",icon:Ts,resource:"admin:audit"},{path:"/admin/backup",label:"Backup & Restore",icon:ws,resource:"admin:backup"}].filter(t=>ss(n.role,t.resource,"read",n.permissionOverrides)):[];return e.jsx("div",{className:"w-64 bg-surface-800/40 backdrop-blur-xl border-r border-surface-600/50 min-h-screen p-4",children:e.jsx("nav",{className:"space-y-2",children:a.map(t=>e.jsxs(Ge,{to:t.path,className:({isActive:i})=>`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${i?"bg-brand-600/30 text-surface-100 border border-teal-500/50":"text-surface-100/60 hover:text-surface-100 hover:bg-surface-800/40"}`,children:[e.jsx(t.icon,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:t.label})]},t.path))})})},Fs=()=>oe(()=>f.commissionTiers.orderBy("minMargin").toArray(),[]),Us=()=>oe(()=>f.residualCurves.toArray(),[]),_s=()=>oe(async()=>(await f.settings.toArray()).reduce((r,a)=>({...r,[a.key]:a.value}),{}),[]),Vs=async(n,r)=>{await f.transaction("rw",f.commissionTiers,f.auditLog,async()=>{await f.commissionTiers.clear(),await f.commissionTiers.bulkAdd(n),await f.auditLog.add({id:crypto.randomUUID(),timestamp:new Date().toISOString(),userId:r,action:"update",entityType:"commissionTiers",entityId:"all",changes:{tiers:n},oldValues:null,newValues:n})})},Bs=async(n,r)=>{await f.transaction("rw",f.residualCurves,f.auditLog,async()=>{await f.residualCurves.clear(),await f.residualCurves.bulkAdd(n),await f.auditLog.add({id:crypto.randomUUID(),timestamp:new Date().toISOString(),userId:r,action:"update",entityType:"residualCurves",entityId:"all",changes:{curves:n},oldValues:null,newValues:n})})},Hs=async(n,r)=>{await f.transaction("rw",f.settings,f.auditLog,async()=>{for(const[a,t]of Object.entries(n))await f.settings.put({key:a,value:t});await f.auditLog.add({id:crypto.randomUUID(),timestamp:new Date().toISOString(),userId:r,action:"update",entityType:"settings",entityId:"defaults",changes:{values:n},oldValues:null,newValues:n})})},qs=async n=>{try{const r=await f.quotes.toArray();let a=0;for(const t of r)try{const i=typeof t.slots=="string"?JSON.parse(t.slots):t.slots;Array.isArray(i)&&i.some(N=>!N.isEmpty&&N.batteryChemistry===n)&&a++}catch{}return a}catch(r){return console.error("Error calculating residual curve impact:",r),0}},Me=n=>{const r=[];if(n.length===0)return r.push({message:"At least one commission tier is required"}),r;n.forEach((t,i)=>{t.minMargin>=t.maxMargin&&r.push({message:`Tier ${i+1}: Min margin must be less than max margin`,field:`tier${i}`}),(t.minMargin<0||t.maxMargin>100)&&r.push({message:`Tier ${i+1}: Margin must be between 0% and 100%`,field:`tier${i}`}),(t.commissionRate<0||t.commissionRate>100)&&r.push({message:`Tier ${i+1}: Commission rate must be between 0% and 100%`,field:`tier${i}`})});const a=[...n].sort((t,i)=>t.minMargin-i.minMargin);for(let t=0;t<a.length-1;t++)if(a[t].maxMargin!==a[t+1].minMargin){const i=a[t+1].minMargin-a[t].maxMargin;i>0&&r.push({message:`Gap of ${i}% between tier ${t+1} and tier ${t+2}`,field:"gap"})}return r},Ie=n=>{const r=[],a=[36,48,60,72,84];a.forEach(t=>{const i=`term${t}`,h=n[i];(h<0||h>100)&&r.push({message:`${t}mo value must be between 0-100%`,field:i})});for(let t=0;t<a.length-1;t++){const i=`term${a[t]}`,h=`term${a[t+1]}`,N=n[i],b=n[h];N<b&&r.push({message:`${a[t]}mo value (${N}%) must be >= ${a[t+1]}mo value (${b}%)`,field:i})}return r},Oe=n=>{const r=[],a=Number(n.defaultROE),t=Number(n.defaultInterestRate),i=Number(n.defaultCPIRate),h=Number(n.defaultOperatingHours),N=Number(n.defaultLeaseTerm),b=Number(n.defaultTelematicsCost);return n.defaultROE&&(isNaN(a)||a<=0||a>100)&&r.push({message:"Default ROE must be between 0 and 100",field:"defaultROE"}),n.defaultInterestRate&&(isNaN(t)||t<0||t>50)&&r.push({message:"Default interest rate must be between 0% and 50%",field:"defaultInterestRate"}),n.defaultCPIRate&&(isNaN(i)||i<0||i>30)&&r.push({message:"Default CPI rate must be between 0% and 30%",field:"defaultCPIRate"}),n.defaultOperatingHours&&(isNaN(h)||h<=0||h>720)&&r.push({message:"Operating hours must be between 1 and 720 per month",field:"defaultOperatingHours"}),n.defaultLeaseTerm&&![36,48,60,72,84].includes(N)&&r.push({message:"Lease term must be 36, 48, 60, 72, or 84 months",field:"defaultLeaseTerm"}),n.defaultTelematicsCost&&(isNaN(b)||b<0)&&r.push({message:"Telematics cost cannot be negative",field:"defaultTelematicsCost"}),r},Js=()=>{const n=Fs(),{user:r}=Y(),[a,t]=m.useState([]),[i,h]=m.useState([]),[N,b]=m.useState(!1),[y,w]=m.useState(!1);m.useEffect(()=>{n&&n.length>0&&t(n)},[n]);const l=(o,x,u)=>{const p=[...a];p[o]={...p[o],[x]:u},t(p),w(!1)},C=()=>{const o=a[a.length-1],x={minMargin:o?o.maxMargin:0,maxMargin:o?o.maxMargin+10:10,commissionRate:2};t([...a,x]),w(!1)},s=o=>{if(a.length<=1){h(["At least one commission tier is required"]);return}const x=a.filter((u,p)=>p!==o);t(x),w(!1)},g=()=>{confirm("Reset commission tiers to default values? This cannot be undone.")&&(t([{minMargin:0,maxMargin:15,commissionRate:2},{minMargin:15,maxMargin:25,commissionRate:4},{minMargin:25,maxMargin:35,commissionRate:6},{minMargin:35,maxMargin:100,commissionRate:8}]),w(!1))};m.useEffect(()=>{if(a.length>0){const o=Me(a);h(o.map(x=>x.message))}},[a]);const j=async()=>{const o=Me(a);if(o.length>0){h(o.map(x=>x.message));return}b(!0);try{await Vs(a,r?.id||"unknown"),w(!0),setTimeout(()=>w(!1),3e3)}catch(x){console.error("Error saving commission tiers:",x),h(["Failed to save commission tiers"])}finally{b(!1)}},k=25,T=a.find(o=>k>=o.minMargin&&k<o.maxMargin),S=T?T.commissionRate:0;return n?e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-surface-100",children:"Commission Tiers Configuration"}),e.jsx("p",{className:"text-surface-100/60 text-sm mt-1",children:"Define commission rates based on margin percentage"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:g,className:"btn btn-secondary flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),"Reset to Defaults"]}),e.jsx("button",{onClick:j,disabled:N||i.length>0,className:"btn btn-primary flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Saving..."]}):y?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-4 h-4"}),"Saved!"]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"w-4 h-4"}),"Save Changes"]})})]})]}),i.length>0&&e.jsx("div",{className:"mb-6 bg-red-500/10 border border-red-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ne,{className:"w-5 h-5 text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-red-400 font-semibold mb-2",children:"Validation Errors"}),e.jsx("ul",{className:"text-red-300 text-sm space-y-1",children:i.map((o,x)=>e.jsx("li",{children:o},x))})]})]})}),e.jsx("div",{className:"overflow-x-auto mb-6",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-surface-700/50",children:[e.jsx("th",{className:"text-left text-surface-100/80 font-semibold py-3 px-4",children:"Min Margin %"}),e.jsx("th",{className:"text-left text-surface-100/80 font-semibold py-3 px-4",children:"Max Margin %"}),e.jsx("th",{className:"text-left text-surface-100/80 font-semibold py-3 px-4",children:"Commission Rate %"}),e.jsx("th",{className:"text-right text-surface-100/80 font-semibold py-3 px-4",children:"Actions"})]})}),e.jsx("tbody",{children:a.map((o,x)=>e.jsxs("tr",{className:"border-b border-white/5 hover:bg-surface-800/40 transition-colors",children:[e.jsx("td",{className:"py-3 px-4",children:e.jsx("input",{type:"number",value:o.minMargin,onChange:u=>l(x,"minMargin",Number(u.target.value)),step:"0.1",className:"w-24 bg-surface-800/40 border border-surface-700/50 rounded-lg px-3 py-2 text-surface-100 focus:outline-none focus:border-brand-500"})}),e.jsx("td",{className:"py-3 px-4",children:e.jsx("input",{type:"number",value:o.maxMargin,onChange:u=>l(x,"maxMargin",Number(u.target.value)),step:"0.1",className:"w-24 bg-surface-800/40 border border-surface-700/50 rounded-lg px-3 py-2 text-surface-100 focus:outline-none focus:border-brand-500"})}),e.jsx("td",{className:"py-3 px-4",children:e.jsx("input",{type:"number",value:o.commissionRate,onChange:u=>l(x,"commissionRate",Number(u.target.value)),step:"0.1",className:"w-24 bg-surface-800/40 border border-surface-700/50 rounded-lg px-3 py-2 text-surface-100 focus:outline-none focus:border-brand-500"})}),e.jsx("td",{className:"py-3 px-4 text-right",children:e.jsx("button",{onClick:()=>s(x),className:"text-red-400 hover:text-red-300 p-2 rounded-lg hover:bg-red-500/10 transition-colors",title:"Remove tier",children:e.jsx(ce,{className:"w-4 h-4"})})})]},x))})]})}),e.jsxs("button",{onClick:C,className:"btn btn-secondary flex items-center gap-2 mb-6",children:[e.jsx(we,{className:"w-4 h-4"}),"Add Tier"]}),e.jsxs("div",{className:"mb-6 bg-surface-800/40 rounded-xl p-6",children:[e.jsx("h4",{className:"text-surface-100 font-semibold mb-4",children:"Commission Curve Visualization"}),e.jsx("div",{className:"space-y-2",children:a.map((o,x)=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"w-32 text-sm text-surface-100/60",children:[o.minMargin,"% - ",o.maxMargin,"%"]}),e.jsx("div",{className:"flex-1 bg-surface-800/40 rounded-full h-8 relative overflow-hidden",children:e.jsx("div",{className:"absolute inset-y-0 left-0 bg-gradient-to-r from-teal-500 to-teal-600 flex items-center justify-end px-4 transition-all duration-300",style:{width:`${o.commissionRate*10}%`},children:e.jsxs("span",{className:"text-surface-100 font-medium text-sm",children:[o.commissionRate,"%"]})})})]},x))})]}),e.jsx("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"text-blue-400 text-sm",children:[e.jsx("strong",{children:"Example:"})," A deal with ",k,"% margin earns"," ",e.jsxs("strong",{children:[S,"%"]})," commission on the total sales value."]})})]}):e.jsx("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:e.jsx("div",{className:"text-surface-100/60",children:"Loading commission tiers..."})})},Qs=()=>{const n=Us(),{user:r}=Y(),[a,t]=m.useState([]),[i,h]=m.useState({}),[N,b]=m.useState(!1),[y,w]=m.useState(!1),[l,C]=m.useState({}),s=[36,48,60,72,84];m.useEffect(()=>{if(n&&n.length>0){t(n);let o=!1;return(async()=>{for(const u of n){if(o)return;try{const p=await qs(u.chemistry);o||C(E=>({...E,[u.chemistry]:p}))}catch(p){console.error("Error loading impact for",u.chemistry,p)}}})(),()=>{o=!0}}},[n]);const g=(o,x,u)=>{const p=a.map(E=>E.chemistry===o?{...E,[`term${x}`]:u}:E);t(p),w(!1)};m.useEffect(()=>{if(a.length>0){const o={};a.forEach(x=>{const u=Ie(x);u.length>0&&(o[x.chemistry]=u.map(p=>p.message))}),h(o)}},[a]);const j=async o=>{const x=a;for(const u of x){const p=Ie(u);if(p.length>0){h(E=>({...E,[u.chemistry]:p.map(A=>A.message)}));return}}b(!0);try{await Bs(a,r?.id||"unknown"),w(!0),setTimeout(()=>w(!1),3e3)}catch(u){console.error("Error saving residual curves:",u),h({general:["Failed to save residual curves"]})}finally{b(!1)}},k=o=>a.find(x=>x.chemistry===o);if(!n)return e.jsx("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:e.jsx("div",{className:"text-surface-100/60",children:"Loading residual curves..."})});const T=k("lead-acid"),S=k("lithium-ion");return e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-surface-100",children:"Residual Value Curves Configuration"}),e.jsx("p",{className:"text-surface-100/60 text-sm mt-1",children:"Define residual value percentages by battery chemistry and lease term"})]}),e.jsx("button",{onClick:()=>j(),disabled:N||Object.keys(i).length>0,className:"btn btn-primary flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Saving..."]}):y?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-4 h-4"}),"Saved!"]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"w-4 h-4"}),"Save All Changes"]})})]}),i.general&&e.jsx("div",{className:"mb-6 bg-red-500/10 border border-red-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ne,{className:"w-5 h-5 text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-red-400 font-semibold mb-2",children:"Validation Errors"}),e.jsx("ul",{className:"text-red-300 text-sm space-y-1",children:i.general.map((o,x)=>e.jsx("li",{children:o},x))})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[T&&e.jsxs("div",{className:"bg-surface-800/40 rounded-xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsxs("h4",{className:"text-surface-100 font-semibold flex items-center gap-2",children:[e.jsx(De,{className:"w-5 h-5 text-orange-400"}),"Lead-Acid (PB) Batteries"]}),e.jsxs("p",{className:"text-surface-100/60 text-sm mt-1",children:["Impact: ",l["lead-acid"]!==void 0?l["lead-acid"]:"-"," active quotes"]})]})}),i["lead-acid"]&&e.jsx("div",{className:"mb-4 bg-red-500/10 border border-red-500/30 rounded-lg p-3",children:e.jsx("ul",{className:"text-red-300 text-sm space-y-1",children:i["lead-acid"].map((o,x)=>e.jsx("li",{children:o},x))})}),e.jsx("div",{className:"space-y-3 mb-4",children:s.map(o=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"w-20 text-surface-100/80 text-sm",children:[o," months"]}),e.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[e.jsx("input",{type:"number",value:T[`term${o}`],onChange:x=>g("lead-acid",o,Number(x.target.value)),min:"0",max:"100",step:"0.1",className:"flex-1 bg-surface-800/40 border border-surface-700/50 rounded-lg px-3 py-2 text-surface-100 focus:outline-none focus:border-brand-500"}),e.jsx("span",{className:"text-surface-100/60 text-sm w-8",children:"%"})]})]},o))}),e.jsxs("div",{className:"bg-surface-800/40 rounded-lg p-4",children:[e.jsx("div",{className:"text-surface-100/60 text-xs mb-2",children:"Residual Value Trend"}),e.jsx("div",{className:"flex items-end justify-between gap-1 h-24",children:s.map(o=>{const x=T[`term${o}`];return e.jsxs("div",{className:"flex-1 flex flex-col items-center gap-1",children:[e.jsx("div",{className:"w-full bg-gradient-to-t from-orange-500 to-orange-400 rounded-t transition-all duration-300",style:{height:`${x}%`}}),e.jsxs("div",{className:"text-surface-100/60 text-xs",children:[o,"m"]})]},o)})})]}),e.jsx("div",{className:"mt-4 bg-blue-500/10 border border-blue-500/30 rounded-lg p-3",children:e.jsxs("div",{className:"text-blue-400 text-xs",children:[e.jsx("strong",{children:"Example:"})," A lead-acid forklift with 60-month lease retains"," ",e.jsxs("strong",{children:[T.term60,"%"]})," of its value at end of term."]})})]}),S&&e.jsxs("div",{className:"bg-surface-800/40 rounded-xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{children:[e.jsxs("h4",{className:"text-surface-100 font-semibold flex items-center gap-2",children:[e.jsx(De,{className:"w-5 h-5 text-green-400"}),"Lithium-Ion (Li-ion) Batteries"]}),e.jsxs("p",{className:"text-surface-100/60 text-sm mt-1",children:["Impact: ",l["lithium-ion"]!==void 0?l["lithium-ion"]:"-"," active quotes"]})]})}),i["lithium-ion"]&&e.jsx("div",{className:"mb-4 bg-red-500/10 border border-red-500/30 rounded-lg p-3",children:e.jsx("ul",{className:"text-red-300 text-sm space-y-1",children:i["lithium-ion"].map((o,x)=>e.jsx("li",{children:o},x))})}),e.jsx("div",{className:"space-y-3 mb-4",children:s.map(o=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"w-20 text-surface-100/80 text-sm",children:[o," months"]}),e.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[e.jsx("input",{type:"number",value:S[`term${o}`],onChange:x=>g("lithium-ion",o,Number(x.target.value)),min:"0",max:"100",step:"0.1",className:"flex-1 bg-surface-800/40 border border-surface-700/50 rounded-lg px-3 py-2 text-surface-100 focus:outline-none focus:border-brand-500"}),e.jsx("span",{className:"text-surface-100/60 text-sm w-8",children:"%"})]})]},o))}),e.jsxs("div",{className:"bg-surface-800/40 rounded-lg p-4",children:[e.jsx("div",{className:"text-surface-100/60 text-xs mb-2",children:"Residual Value Trend"}),e.jsx("div",{className:"flex items-end justify-between gap-1 h-24",children:s.map(o=>{const x=S[`term${o}`];return e.jsxs("div",{className:"flex-1 flex flex-col items-center gap-1",children:[e.jsx("div",{className:"w-full bg-gradient-to-t from-green-500 to-green-400 rounded-t transition-all duration-300",style:{height:`${x}%`}}),e.jsxs("div",{className:"text-surface-100/60 text-xs",children:[o,"m"]})]},o)})})]}),e.jsx("div",{className:"mt-4 bg-blue-500/10 border border-blue-500/30 rounded-lg p-3",children:e.jsxs("div",{className:"text-blue-400 text-xs",children:[e.jsx("strong",{children:"Example:"})," A lithium-ion forklift with 60-month lease retains"," ",e.jsxs("strong",{children:[S.term60,"%"]})," of its value at end of term."]})})]})]}),e.jsx("div",{className:"mt-6 bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"text-yellow-400 text-sm",children:[e.jsx("strong",{children:"Important:"})," Residual values should decrease as lease term increases. Changes will affect lease rate calculations for new quotes immediately."]})})]})},zs=()=>{const n=_s(),{user:r}=Y(),[a,t]=m.useState({}),[i,h]=m.useState([]),[N,b]=m.useState(!1),[y,w]=m.useState(!1);m.useEffect(()=>{if(n){const s=ts();t({defaultROE:n.defaultROE||String(s.customerROE),defaultInterestRate:n.defaultInterestRate||String(s.interestRate),defaultCPIRate:n.defaultCPIRate||String(s.cpiRate),defaultOperatingHours:n.defaultOperatingHours||String(s.operatingHours),defaultLeaseTerm:n.defaultLeaseTerm||String(s.leaseTerm),defaultTelematicsCost:n.defaultTelematicsCost||String(s.telematicsCost)})}},[n]);const l=(s,g)=>{t(j=>({...j,[s]:g})),w(!1)};m.useEffect(()=>{if(Object.keys(a).length>0){const s=Oe(a);h(s.map(g=>g.message))}},[a]);const C=async()=>{const s=Oe(a);if(s.length>0){h(s.map(g=>g.message));return}b(!0);try{await Hs(a,r?.id||"unknown"),w(!0),setTimeout(()=>w(!1),3e3)}catch(g){console.error("Error saving default values:",g),h(["Failed to save default values"])}finally{b(!1)}};return n?e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-bold text-surface-100 flex items-center gap-2",children:[e.jsx(ge,{className:"w-6 h-6"}),"Default Values Configuration"]}),e.jsx("p",{className:"text-surface-100/60 text-sm mt-1",children:"Set default values used for new quotes"})]}),e.jsx("button",{onClick:C,disabled:N||i.length>0,className:"btn btn-primary flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),"Saving..."]}):y?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-4 h-4"}),"Saved!"]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"w-4 h-4"}),"Save Changes"]})})]}),i.length>0&&e.jsx("div",{className:"mb-6 bg-red-500/10 border border-red-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ne,{className:"w-5 h-5 text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-red-400 font-semibold mb-2",children:"Validation Errors"}),e.jsx("ul",{className:"text-red-300 text-sm space-y-1",children:i.map((s,g)=>e.jsx("li",{children:s},g))})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-surface-800/40 rounded-xl p-6",children:[e.jsx("label",{className:"block text-surface-100 font-semibold mb-2",children:"Default Customer ROE (Rate of Exchange)"}),e.jsx("p",{className:"text-surface-100/60 text-sm mb-3",children:"EUR to ZAR exchange rate for customer pricing"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:a.defaultROE||"",onChange:s=>l("defaultROE",s.target.value),step:"0.01",className:"flex-1 bg-surface-800/40 border border-surface-700/50 rounded-lg px-4 py-3 text-surface-100 text-lg focus:outline-none focus:border-brand-500"}),e.jsx("span",{className:"text-surface-100/60",children:"ZAR/EUR"})]})]}),e.jsxs("div",{className:"bg-surface-800/40 rounded-xl p-6",children:[e.jsx("label",{className:"block text-surface-100 font-semibold mb-2",children:"Default Interest Rate"}),e.jsx("p",{className:"text-surface-100/60 text-sm mb-3",children:"Annual interest rate for lease calculations"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:a.defaultInterestRate||"",onChange:s=>l("defaultInterestRate",s.target.value),step:"0.1",className:"flex-1 bg-surface-800/40 border border-surface-700/50 rounded-lg px-4 py-3 text-surface-100 text-lg focus:outline-none focus:border-brand-500"}),e.jsx("span",{className:"text-surface-100/60",children:"%"})]})]}),e.jsxs("div",{className:"bg-surface-800/40 rounded-xl p-6",children:[e.jsx("label",{className:"block text-surface-100 font-semibold mb-2",children:"Default CPI Rate"}),e.jsx("p",{className:"text-surface-100/60 text-sm mb-3",children:"Consumer Price Index for cost escalations"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:a.defaultCPIRate||"",onChange:s=>l("defaultCPIRate",s.target.value),step:"0.1",className:"flex-1 bg-surface-800/40 border border-surface-700/50 rounded-lg px-4 py-3 text-surface-100 text-lg focus:outline-none focus:border-brand-500"}),e.jsx("span",{className:"text-surface-100/60",children:"%"})]})]}),e.jsxs("div",{className:"bg-surface-800/40 rounded-xl p-6",children:[e.jsx("label",{className:"block text-surface-100 font-semibold mb-2",children:"Default Operating Hours/Month"}),e.jsx("p",{className:"text-surface-100/60 text-sm mb-3",children:"Expected monthly operating hours per unit"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:a.defaultOperatingHours||"",onChange:s=>l("defaultOperatingHours",s.target.value),step:"1",className:"flex-1 bg-surface-800/40 border border-surface-700/50 rounded-lg px-4 py-3 text-surface-100 text-lg focus:outline-none focus:border-brand-500"}),e.jsx("span",{className:"text-surface-100/60",children:"hours"})]})]}),e.jsxs("div",{className:"bg-surface-800/40 rounded-xl p-6",children:[e.jsx("label",{className:"block text-surface-100 font-semibold mb-2",children:"Default Lease Term"}),e.jsx("p",{className:"text-surface-100/60 text-sm mb-3",children:"Standard lease duration for new quotes"}),e.jsxs("select",{value:a.defaultLeaseTerm||"60",onChange:s=>l("defaultLeaseTerm",s.target.value),className:"w-full bg-surface-800/40 border border-surface-700/50 rounded-lg px-4 py-3 text-surface-100 text-lg focus:outline-none focus:border-brand-500",children:[e.jsx("option",{value:"36",children:"36 months (3 years)"}),e.jsx("option",{value:"48",children:"48 months (4 years)"}),e.jsx("option",{value:"60",children:"60 months (5 years)"}),e.jsx("option",{value:"72",children:"72 months (6 years)"}),e.jsx("option",{value:"84",children:"84 months (7 years)"})]})]}),e.jsxs("div",{className:"bg-surface-800/40 rounded-xl p-6",children:[e.jsx("label",{className:"block text-surface-100 font-semibold mb-2",children:"Default Telematics Cost"}),e.jsx("p",{className:"text-surface-100/60 text-sm mb-3",children:"Monthly telematics and tracking cost per unit"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:a.defaultTelematicsCost||"",onChange:s=>l("defaultTelematicsCost",s.target.value),step:"10",className:"flex-1 bg-surface-800/40 border border-surface-700/50 rounded-lg px-4 py-3 text-surface-100 text-lg focus:outline-none focus:border-brand-500"}),e.jsx("span",{className:"text-surface-100/60",children:"ZAR/mo"})]})]})]}),e.jsx("div",{className:"mt-6 bg-blue-500/10 border border-blue-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"text-blue-400 text-sm",children:[e.jsx("strong",{children:"Note:"})," These defaults are used as initial values when creating new quotes. Users can override these values on a per-quote basis. Changes take effect immediately for new quotes."]})})]}):e.jsx("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:e.jsx("div",{className:"text-surface-100/60",children:"Loading default values..."})})};class pe extends m.Component{constructor(r){super(r),this.state={hasError:!1,error:null}}static getDerivedStateFromError(r){return{hasError:!0,error:r}}componentDidCatch(r,a){console.error(`Error in ${this.props.tabName} tab:`,r,a)}render(){return this.state.hasError?e.jsx("div",{className:"bg-red-500/10 border border-red-500/30 rounded-2xl p-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ne,{className:"w-6 h-6 text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-red-400 mb-2",children:["Error loading ",this.props.tabName]}),e.jsx("p",{className:"text-surface-100/60 text-sm mb-3",children:"This component encountered an error while rendering."}),this.state.error&&e.jsx("pre",{className:"text-red-300 text-xs bg-red-500/5 border border-red-500/20 rounded-lg p-3 mb-4 overflow-x-auto whitespace-pre-wrap",children:this.state.error.message}),e.jsxs("button",{onClick:()=>this.setState({hasError:!1,error:null}),className:"flex items-center gap-2 px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-200 text-sm transition-colors",children:[e.jsx(ue,{className:"w-3.5 h-3.5"}),"Retry"]})]})]})}):this.props.children}}const Gs=()=>{const[n,r]=m.useState("commission"),a=[{id:"commission",label:"Commission Tiers",icon:as,description:"Set commission rates based on margin"},{id:"residual",label:"Residual Curves",icon:Ms,description:"Define residual values by chemistry and term"},{id:"defaults",label:"Default Values",icon:ge,description:"Set default values for new quotes"}],t=()=>{switch(n){case"commission":return e.jsx(pe,{tabName:"Commission Tiers",children:e.jsx(Js,{})},"commission");case"residual":return e.jsx(pe,{tabName:"Residual Curves",children:e.jsx(Qs,{})},"residual");case"defaults":return e.jsx(pe,{tabName:"Default Values",children:e.jsx(zs,{})},"defaults");default:return null}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold text-surface-100 mb-2",children:"Pricing Configuration"}),e.jsx("p",{className:"text-surface-100/60",children:"Configure pricing parameters and default values for the quotation system"})]}),e.jsx("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-2",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2",children:a.map(i=>{const h=i.icon,N=n===i.id;return e.jsxs("button",{onClick:()=>r(i.id),className:`
                  flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200
                  ${N?"bg-brand-500 text-surface-100 shadow-lg shadow-brand-500/20":"bg-surface-800/40 text-surface-100/60 hover:bg-surface-700/50 hover:text-surface-100"}
                `,children:[e.jsx(h,{className:"w-5 h-5 flex-shrink-0"}),e.jsxs("div",{className:"text-left flex-1 min-w-0",children:[e.jsx("div",{className:"font-semibold text-sm",children:i.label}),e.jsx("div",{className:"text-xs opacity-80 truncate",children:i.description})]})]},i.id)})})}),e.jsx("div",{className:"min-h-[600px]",children:t()})]})};class Ks{async getMatrixByModelFamily(r){try{return await f.configurationMatrices.where("baseModelFamily").equals(r).first()||null}catch(a){return console.error(`Error fetching matrix for family ${r}:`,a),null}}async getVariantByCode(r){try{const a=await f.configurationMatrices.toArray();for(const t of a){const i=t.variants.find(h=>h.variantCode===r);if(i)return i}return null}catch(a){return console.error(`Error fetching variant ${r}:`,a),null}}async saveMatrix(r){try{const a=new Date().toISOString(),t=await f.configurationMatrices.get(r.id),i={...r,createdAt:t?.createdAt||a,updatedAt:a};return await f.configurationMatrices.put(i),i.id}catch(a){throw console.error("Error saving configuration matrix:",a),new Error("Failed to save configuration matrix")}}async updateOption(r,a,t,i,h){try{const N=await f.configurationMatrices.get(r);if(!N)throw new Error(`Matrix ${r} not found`);const b=N.variants.find(l=>l.variantCode===a);if(!b)throw new Error(`Variant ${a} not found in matrix ${r}`);const y=b.specifications.find(l=>l.groupCode===t);if(!y)throw new Error(`Spec group ${t} not found in variant ${a}`);const w=y.options.find(l=>l.optionCode===i);if(!w)throw new Error(`Option ${i} not found in spec group ${t}`);Object.assign(w,h),await f.configurationMatrices.put({...N,updatedAt:new Date().toISOString()})}catch(N){throw console.error("Error updating option:",N),N}}async list(){try{return await f.configurationMatrices.toArray()}catch(r){return console.error("Error listing configuration matrices:",r),[]}}async delete(r){try{await f.configurationMatrices.delete(r)}catch(a){throw console.error(`Error deleting matrix ${r}:`,a),new Error("Failed to delete configuration matrix")}}getAvailableOptions(r,a){const t=r.specifications.find(i=>i.groupCode===a);return t?t.options.filter(i=>i.availability>0):[]}getStandardOptions(r){const a={};return r.specifications.forEach(t=>{const i=t.options.find(h=>h.availability===1);i&&(a[t.groupCode]=i)}),a}calculateConfigurationCost(r,a){let t=0;return Object.entries(a).forEach(([i,h])=>{const N=r.specifications.find(b=>b.groupCode===i);if(N){const b=N.options.find(y=>y.optionCode===h);b&&b.availability>1&&(t+=b.eurCostDelta)}}),t}generateConfigurationSummary(r,a){const t=[];return t.push(`${r.variantName} (${r.variantCode})`),Object.entries(a).forEach(([i,h])=>{const N=r.specifications.find(b=>b.groupCode===i);if(N){const b=N.options.find(y=>y.optionCode===h);if(b&&b.availability>1){const y=b.eurCostDelta>0?` (+â‚¬${b.eurCostDelta.toLocaleString()})`:"";t.push(`${b.description}${y}`)}}}),t}}const Le=new Ks;function Ws(){return oe(async()=>await f.configurationMatrices.toArray(),[])}async function Xs(n){const r=[],a=[];try{const t=await n.arrayBuffer(),i=gs(t,{type:"array"});if(i.SheetNames.length===0)return r.push("Excel file has no sheets"),{success:!1,errors:r,warnings:a,stats:{variantsFound:0,specGroupsFound:0,optionsImported:0}};const h=i.SheetNames[0],N=i.Sheets[h],b=X.sheet_to_json(N,{header:1});if(b.length<2)return r.push("Excel file has no data rows"),{success:!1,errors:r,warnings:a,stats:{variantsFound:0,specGroupsFound:0,optionsImported:0}};const y=0,w=1,l=2,C=3,s=4,g=b[1][y]?.toString()||"UNKNOWN",j=[],k=[];for(let u=1;u<b.length;u++){const p=b[u];if(p[l]?.toString()==="1100"){const A=p[C]?.toString()||"";for(let D=s;D<=s+4;D++)if($e(p[D])>0){const O=D-s,L=Ys(A,O);L&&!k.includes(L)&&(k.push(L),j.push({variantCode:L,variantName:A||`Variant ${O+1}`,modelCode:g,baseEurCost:0,specifications:[]}))}}}if(j.length===0)return r.push("No variants found in Excel file (no 1100 spec code rows)"),{success:!1,errors:r,warnings:a,stats:{variantsFound:0,specGroupsFound:0,optionsImported:0}};const T=new Map;let S=0;for(let u=1;u<b.length;u++){const p=b[u],E=p[l]?.toString(),A=p[w]?.toString()||"",D=p[C]?.toString()||"";if(!E||!A){a.push(`Row ${u+1}: Missing spec code or long code`);continue}for(let I=0;I<j.length&&I<5;I++){const O=s+I,L=$e(p[O]),U={optionCode:A,specCode:E,description:D,availability:L,eurCostDelta:0,isDefault:L===1},_=j[I].variantCode;T.has(_)||T.set(_,new Map);const F=T.get(_);F.has(E)||F.set(E,[]),F.get(E).push(U),S++}}const o=new Set;return j.forEach(u=>{const p=T.get(u.variantCode);if(!p)return;const E=[];p.forEach((A,D)=>{o.add(D),E.push({groupCode:D,groupName:Zs(D),category:et(D),options:A})}),u.specifications=E}),{success:!0,matrix:{id:crypto.randomUUID(),baseModelFamily:g,variants:j,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},errors:r,warnings:a,stats:{variantsFound:j.length,specGroupsFound:o.size,optionsImported:S}}}catch(t){return r.push(`Import failed: ${t instanceof Error?t.message:"Unknown error"}`),{success:!1,errors:r,warnings:a,stats:{variantsFound:0,specGroupsFound:0,optionsImported:0}}}}function $e(n){const r=parseInt(n?.toString()||"0",10);return r===0?0:r===1?1:r===2?2:r===3?3:0}function Ys(n,r){const a=n.match(/([A-Z]+\d+[A-Z]?)/);return a?a[1]:`VARIANT_${r+1}`}function Zs(n){return{1100:"MODEL",1135:"BATTERY TECHNOLOGY",1200:"PEDAL SYSTEM",1300:"WHEELS & TIRES",2200:"DRIVE AXLE",2300:"LOAD AXLE",3200:"MAST",3300:"HYDRAULICS",4100:"OPERATOR CONTROLS",4200:"LIGHTING",4300:"SAFETY FEATURES",5100:"CABIN",5200:"SEATING"}[n]||`SPEC ${n}`}function et(n){const r=parseInt(n,10);return r>=1100&&r<1200?"Basic":r>=1200&&r<2e3?"Battery":r>=2e3&&r<3e3?"Wheels & Tires":r>=3e3&&r<4e3?"Mast & Hydraulics":r>=4e3&&r<5e3?"Controls & Safety":r>=5e3&&r<6e3?"Cabin & Comfort":"Other"}function st(n){const r=[],a=n.variants.map(y=>y.variantCode);r.push(["Material Number","Long Code","Spec Code","Description",...a]);const t=new Set;n.variants.forEach(y=>{y.specifications.forEach(w=>{t.add(w.groupCode)})}),Array.from(t).sort().forEach(y=>{const w=new Map;n.variants.forEach(l=>{const C=l.specifications.find(s=>s.groupCode===y);C&&C.options.forEach(s=>{w.has(s.optionCode)||w.set(s.optionCode,[]),w.get(s.optionCode).push(s)})}),w.forEach((l,C)=>{const s=l[0],g=[n.baseModelFamily,C,y,s.description];n.variants.forEach(()=>{const j=l.find(()=>!0);g.push(j?.availability??0)}),r.push(g)})});const h=X.aoa_to_sheet(r),N=X.book_new();X.book_append_sheet(N,h,"Configuration Matrix");const b=js(N,{bookType:"xlsx",type:"array"});return new Blob([b],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}const tt=()=>{const n=Ws(),[r,a]=m.useState(!1),[t,i]=m.useState(null),{confirm:h,ConfirmDialogElement:N}=rs(),b=async l=>{const C=l.target.files?.[0];if(C){a(!0),i("Importing...");try{const s=await Xs(C);s.success&&s.matrix?(await Le.saveMatrix(s.matrix),i(`Success! Imported ${s.stats.variantsFound} variants, ${s.stats.specGroupsFound} spec groups, ${s.stats.optionsImported} options.`),s.warnings.length>0&&console.warn("Import warnings:",s.warnings)):i(`Import failed: ${s.errors.join(", ")}`)}catch(s){i(`Import error: ${s instanceof Error?s.message:"Unknown error"}`)}finally{a(!1),l.target.value=""}}},y=async l=>{try{const C=n?.find(k=>k.id===l);if(!C)return;const s=st(C),g=URL.createObjectURL(s),j=document.createElement("a");j.href=g,j.download=`configuration-matrix-${C.baseModelFamily}-${Date.now()}.xlsx`,document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(g)}catch(C){console.error("Export error:",C),P.error("Failed to export configuration matrix")}},w=async l=>{if(await h({title:"Delete Configuration Matrix",message:"Are you sure you want to delete this configuration matrix? This action cannot be undone.",variant:"danger",confirmText:"Delete"}))try{await Le.delete(l),i("Configuration matrix deleted successfully"),P.success("Configuration matrix deleted")}catch{P.error("Failed to delete configuration matrix")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-surface-100",children:"Configuration Matrices"}),e.jsx("p",{className:"text-gray-400 mt-1",children:"Manage Linde forklift configuration matrices and variant options"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"btn btn-primary cursor-pointer flex items-center gap-2",children:[e.jsx(be,{className:"w-4 h-4"}),"Import Excel",e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:b,disabled:r,className:"hidden"})]})})]}),t&&e.jsx("div",{className:`p-4 rounded-lg border ${t.startsWith("Success")?"bg-green-500/10 border-green-500/30 text-green-400":t.startsWith("Import failed")||t.startsWith("Import error")?"bg-red-500/10 border-red-500/30 text-red-400":"bg-blue-500/10 border-blue-500/30 text-blue-400"}`,children:t}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:!n||n.length===0?e.jsxs("div",{className:"col-span-full text-center py-12",children:[e.jsx("p",{className:"text-gray-400 text-lg",children:"No configuration matrices found"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"Import an Excel file to create a new configuration matrix"})]}):n.map(l=>e.jsxs("div",{className:"bg-gray-800/50 border border-gray-700 rounded-lg p-6 hover:border-cyan-500/50 transition-colors",children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-surface-100",children:l.baseModelFamily}),e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:[l.variants.length," variant",l.variants.length!==1?"s":""]})]})}),e.jsx("div",{className:"space-y-2 mb-4",children:l.variants.map(C=>e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-300",children:C.variantCode}),e.jsxs("span",{className:"text-gray-500",children:[C.specifications.length," specs"]})]},C.variantCode))}),e.jsx("div",{className:"border-t border-gray-700 pt-4 mb-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Total Spec Groups"}),e.jsx("p",{className:"text-surface-100 font-semibold",children:Math.max(...l.variants.map(C=>C.specifications.length))})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Last Updated"}),e.jsx("p",{className:"text-surface-100 font-semibold",children:new Date(l.updatedAt).toLocaleDateString()})]})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>y(l.id),className:"flex-1 px-3 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded flex items-center justify-center gap-2 transition-colors",children:[e.jsx(ae,{className:"w-4 h-4"}),"Export"]}),e.jsx("button",{onClick:()=>w(l.id),className:"px-3 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded transition-colors",children:e.jsx(ce,{className:"w-4 h-4"})})]})]},l.id))}),e.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/30 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-400 mb-3",children:"Excel Import Format"}),e.jsxs("div",{className:"text-sm text-gray-300 space-y-2",children:[e.jsx("p",{children:"The Excel file should have the following structure:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 ml-4",children:[e.jsx("li",{children:"Column A: Material Number (base model)"}),e.jsx("li",{children:"Column B: Long Code (option identifier)"}),e.jsx("li",{children:"Column C: Spec Code (1100, 1135, etc.)"}),e.jsx("li",{children:"Column D: Description"}),e.jsx("li",{children:"Columns E-I: INDX1-5 (availability levels: 0-3)"})]}),e.jsxs("p",{className:"mt-3 text-gray-400",children:[e.jsx("strong",{children:"Availability Levels:"})," 0 = Not Available, 1 = Standard, 2 = Optional, 3 = Special Order"]})]})]}),N]})};function He({columns:n,data:r,onEdit:a,onDelete:t,onExport:i,loading:h=!1,emptyMessage:N="No data available"}){const[b,y]=m.useState(null),[w,l]=m.useState("asc"),[C,s]=m.useState(""),[g,j]=m.useState(1),k=10,T=p=>{b===p?l(w==="asc"?"desc":"asc"):(y(p),l("asc"))},o=[...r.filter(p=>Object.values(p).some(E=>String(E).toLowerCase().includes(C.toLowerCase())))].sort((p,E)=>{if(!b)return 0;const A=p[b],D=E[b],I=w==="asc"?1:-1;return A>D?I:A<D?-I:0}),x=Math.ceil(o.length/k),u=o.slice((g-1)*k,g*k);return h?e.jsx("div",{className:"text-center py-8 text-surface-100/60",children:"Loading..."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("input",{type:"text",placeholder:"Search...",value:C,onChange:p=>s(p.target.value),className:"flex-1 px-4 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 placeholder:text-surface-100/30 focus:outline-none focus:ring-2 focus:ring-teal-500"}),i&&e.jsxs("button",{onClick:i,className:"flex items-center gap-2 px-4 py-2 bg-surface-800/40 hover:bg-surface-700/50 border border-surface-700/50 rounded-lg text-surface-100 transition-colors",children:[e.jsx(ae,{className:"w-4 h-4"}),"Export"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-surface-700/50",children:[n.map(p=>e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-surface-100/80",children:p.sortable?e.jsxs("button",{onClick:()=>T(p.key),className:"flex items-center gap-2 hover:text-surface-100",children:[p.label,b===p.key&&(w==="asc"?e.jsx(ns,{className:"w-4 h-4"}):e.jsx(ls,{className:"w-4 h-4"}))]}):p.label},p.key)),(a||t)&&e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-surface-100/80",children:"Actions"})]})}),e.jsx("tbody",{children:u.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:n.length+(a||t?1:0),className:"px-4 py-8 text-center text-surface-100/60",children:N})}):u.map((p,E)=>e.jsxs("tr",{className:"border-b border-white/5 hover:bg-surface-800/40 transition-colors",children:[n.map(A=>e.jsx("td",{className:"px-4 py-3 text-sm text-surface-100",children:A.render?A.render(p[A.key],p):p[A.key]},A.key)),(a||t)&&e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[a&&e.jsx("button",{onClick:()=>a(p),className:"p-1 hover:bg-surface-700/50 rounded text-surface-100/60 hover:text-surface-100",children:e.jsx(Be,{className:"w-4 h-4"})}),t&&e.jsx("button",{onClick:()=>t(p),className:"p-1 hover:bg-red-500/20 rounded text-surface-100/60 hover:text-red-400",children:e.jsx(ce,{className:"w-4 h-4"})})]})})]},E))})]})}),x>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-surface-100/60",children:["Showing ",(g-1)*k+1," to"," ",Math.min(g*k,o.length)," of"," ",o.length," entries"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>j(Math.max(1,g-1)),disabled:g===1,className:"px-3 py-1 bg-surface-800/40 hover:bg-surface-700/50 border border-surface-700/50 rounded text-surface-100 disabled:opacity-50 disabled:cursor-not-allowed",children:"Previous"}),e.jsx("button",{onClick:()=>j(Math.min(x,g+1)),disabled:g===x,className:"px-3 py-1 bg-surface-800/40 hover:bg-surface-700/50 border border-surface-700/50 rounded text-surface-100 disabled:opacity-50 disabled:cursor-not-allowed",children:"Next"})]})]})]})}const qe=({isOpen:n,onClose:r,title:a,children:t,onSave:i,loading:h=!1})=>n?Ke.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center",role:"dialog","aria-modal":"true","aria-labelledby":"edit-modal-title",onKeyDown:N=>N.key==="Escape"&&r(),children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:r,"aria-hidden":"true"}),e.jsxs("div",{className:"relative bg-slate-900 border border-surface-600/50 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden mx-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-surface-700/50",children:[e.jsx("h2",{id:"edit-modal-title",className:"text-2xl font-bold text-surface-100",children:a}),e.jsx("button",{onClick:r,className:"p-2 hover:bg-surface-700/50 rounded-lg text-surface-100/60 hover:text-surface-100 transition-colors",children:e.jsx(Ue,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(85vh-140px)]",children:t}),e.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-surface-700/50",children:[e.jsx("button",{onClick:r,className:"px-4 py-2 bg-surface-800/40 hover:bg-surface-700/50 border border-surface-700/50 rounded-lg text-surface-100 transition-colors",disabled:h,children:"Cancel"}),e.jsx("button",{onClick:i,className:"px-4 py-2 bg-brand-600 hover:bg-brand-700 text-surface-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:h,children:h?"Saving...":"Save Changes"})]})]})]}),document.body):null,at=()=>{const[n,r]=m.useState([]),[a,t]=m.useState(!0),[i,h]=m.useState(!1),[N,b]=m.useState(!1),[y,w]=m.useState(!1),[l,C]=m.useState(null),[s,g]=m.useState({username:"",fullName:"",email:"",password:"",role:"sales_rep",isActive:!0,permissionOverrides:{...ee.sales_rep}}),[j,k]=m.useState(!1),[T,S]=m.useState(""),[o,x]=m.useState(!1),[u,p]=m.useState(""),[E,A]=m.useState(!1),[D,I]=m.useState(!1),[O,L]=m.useState({}),{user:U}=Y(),_=de();m.useEffect(()=>{F()},[]);const F=async()=>{try{t(!0);const c=await f.users.toArray();c.sort((M,V)=>new Date(V.createdAt).getTime()-new Date(M.createdAt).getTime()),r(c)}catch(c){console.error("Failed to load users:",c),P.error("Failed to load users")}finally{t(!1)}},q=()=>{const c={};return s.username.trim()||(c.username="Username is required"),s.fullName.trim()||(c.fullName="Full name is required"),s.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email)||(c.email="Invalid email format"):c.email="Email is required",!l&&!s.password?c.password="Password is required for new users":s.password&&s.password.length<6&&(c.password="Password must be at least 6 characters"),L(c),Object.keys(c).length===0},Q=()=>{C(null),g({username:"",fullName:"",email:"",password:"",role:"sales_rep",isActive:!0,permissionOverrides:{...ee.sales_rep}}),L({}),k(!1),h(!0)},G=c=>{C(c);let M={};try{M=c.permissionOverrides?JSON.parse(c.permissionOverrides):{}}catch{M={}}g({username:c.username,fullName:c.fullName,email:c.email,password:"",role:c.role,isActive:c.isActive,permissionOverrides:M}),L({}),k(!1),h(!0)},K=async()=>{if(q()){A(!0);try{if((!l||l.username!==s.username)&&await f.users.where("username").equals(s.username).first()){L({username:"Username already exists"}),A(!1);return}if((!l||l.email!==s.email)&&await f.users.where("email").equals(s.email).first()){L({email:"Email already exists"}),A(!1);return}if(l){const c={username:s.username,fullName:s.fullName,email:s.email,role:s.role,isActive:s.isActive,permissionOverrides:JSON.stringify(s.permissionOverrides)};if(s.password){const M=await se.genSalt(10);c.passwordHash=await se.hash(s.password,M)}await f.users.update(l.id,c),await _.log({userId:U.id,action:"update",entityType:"user",entityId:l.id,changes:c,oldValues:l,newValues:{...l,...c}})}else{const c=await se.genSalt(10),M=await se.hash(s.password,c),V={id:`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,username:s.username,fullName:s.fullName,email:s.email,passwordHash:M,role:s.role,isActive:s.isActive,permissionOverrides:JSON.stringify(s.permissionOverrides),createdAt:new Date().toISOString()};await f.users.add(V),await _.log({userId:U.id,action:"create",entityType:"user",entityId:V.id,changes:{created:!0},newValues:V})}h(!1),P.success(l?"User updated successfully":"User created successfully"),await F()}catch(c){console.error("Failed to save user:",c),P.error("Failed to save user: "+(c instanceof Error?c.message:"Unknown error"))}finally{A(!1)}}},B=c=>{C(c),b(!0)},v=async()=>{if(!l)return;const c=n.filter(M=>M.role==="system_admin"&&M.isActive&&M.id!==l.id);if(l.role==="system_admin"&&l.isActive&&c.length===0){alert("Cannot delete the last active system admin user"),b(!1);return}try{await f.users.delete(l.id),await _.log({userId:U.id,action:"delete",entityType:"user",entityId:l.id,changes:{deleted:!0},oldValues:l}),b(!1),await F()}catch(M){console.error("Failed to delete user:",M),P.error("Failed to delete user")}},d=c=>{C(c),S(""),x(!1),p(""),w(!0)},R=async()=>{if(!(!l||!U)){if(!T){p("New password is required");return}if(T.length<8){p("Password must be at least 8 characters");return}p(""),I(!0);try{const c=await se.hash(T,10);await f.users.update(l.id,{passwordHash:c}),await _.log({userId:U.id,userName:U.fullName,action:"update",entityType:"user",entityId:l.id,changes:{passwordReset:!0},targetUserId:l.id,targetUserName:l.fullName}),P.success(`Password reset successfully for ${l.username}`),w(!1)}catch(c){console.error("Failed to reset password:",c),P.error("Failed to reset password: "+(c instanceof Error?c.message:"Unknown error"))}finally{I(!1)}}},$=c=>{switch(c){case"system_admin":return"danger";case"ceo":return"warning";case"local_leader":return"brand";case"sales_manager":return"success";case"key_account":return"info";case"sales_rep":return"info";default:return"info"}},J=U?.role==="system_admin",W=[{key:"username",label:"Username",sortable:!0},{key:"fullName",label:"Full Name",sortable:!0},{key:"email",label:"Email",sortable:!0},{key:"role",label:"Role",sortable:!0,render:c=>e.jsx(re,{variant:$(c),children:te[c]||c})},{key:"isActive",label:"Status",sortable:!0,render:c=>e.jsx(re,{variant:c?"success":"info",children:c?"Active":"Inactive"})},{key:"createdAt",label:"Created",sortable:!0,render:c=>new Date(c).toLocaleDateString()},...J?[{key:"id",label:"Reset Password",sortable:!1,render:(c,M)=>e.jsxs("button",{onClick:()=>d(M),title:`Reset password for ${M.username}`,className:"flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/30 hover:border-amber-500/50 text-amber-400 hover:text-amber-300 rounded-lg transition-colors",children:[e.jsx(fe,{className:"w-3.5 h-3.5"}),"Reset"]})}]:[]];return e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-surface-100 mb-1",children:"User Management"}),e.jsx("p",{className:"text-surface-100/60",children:"Manage system users, roles, and permissions"})]}),e.jsxs("button",{onClick:Q,className:"flex items-center gap-2 px-4 py-2 bg-brand-600 hover:bg-brand-700 text-surface-100 rounded-lg transition-colors",children:[e.jsx(we,{className:"w-4 h-4"}),"Add User"]})]}),e.jsx(He,{columns:W,data:n,onEdit:G,onDelete:B,loading:a,emptyMessage:"No users found"}),e.jsx(qe,{isOpen:i,onClose:()=>h(!1),title:l?"Edit User":"Add User",onSave:K,loading:E,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:["Username ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"text",value:s.username,onChange:c=>g({...s,username:c.target.value}),className:"w-full px-4 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 placeholder:text-surface-100/30 focus:outline-none focus:ring-2 focus:ring-teal-500",placeholder:"Enter username"}),O.username&&e.jsx("p",{className:"text-red-400 text-sm mt-1",children:O.username})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:["Full Name ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"text",value:s.fullName,onChange:c=>g({...s,fullName:c.target.value}),className:"w-full px-4 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 placeholder:text-surface-100/30 focus:outline-none focus:ring-2 focus:ring-teal-500",placeholder:"Enter full name"}),O.fullName&&e.jsx("p",{className:"text-red-400 text-sm mt-1",children:O.fullName})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:["Email ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"email",value:s.email,onChange:c=>g({...s,email:c.target.value}),className:"w-full px-4 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 placeholder:text-surface-100/30 focus:outline-none focus:ring-2 focus:ring-teal-500",placeholder:"Enter email"}),O.email&&e.jsx("p",{className:"text-red-400 text-sm mt-1",children:O.email})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:["Password ",!l&&e.jsx("span",{className:"text-red-400",children:"*"}),l&&e.jsx("span",{className:"text-surface-100/60 text-xs",children:"(leave blank to keep current)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:j?"text":"password",value:s.password,onChange:c=>g({...s,password:c.target.value}),className:"w-full px-4 py-2 pr-10 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 placeholder:text-surface-100/30 focus:outline-none focus:ring-2 focus:ring-teal-500",placeholder:l?"Enter new password (optional)":"Enter password"}),e.jsx("button",{type:"button",onClick:()=>k(!j),className:"absolute right-2 top-1/2 -translate-y-1/2 text-surface-100/60 hover:text-surface-100",children:j?e.jsx(Ae,{className:"w-4 h-4"}):e.jsx(ie,{className:"w-4 h-4"})})]}),O.password&&e.jsx("p",{className:"text-red-400 text-sm mt-1",children:O.password})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:["Role ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("select",{value:s.role,onChange:c=>{const M=c.target.value;g({...s,role:M,permissionOverrides:{...ee[M]}})},className:"w-full px-4 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 focus:outline-none focus:ring-2 focus:ring-teal-500",children:is.map(c=>e.jsx("option",{value:c,children:te[c]},c))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isActive",checked:s.isActive,onChange:c=>g({...s,isActive:c.target.checked}),className:"w-4 h-4 bg-surface-800/40 border border-surface-700/50 rounded focus:ring-2 focus:ring-teal-500"}),e.jsx("label",{htmlFor:"isActive",className:"text-sm text-surface-100",children:"Active (user can login)"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-surface-100",children:"Permission Overrides"}),e.jsxs("button",{type:"button",onClick:()=>g({...s,permissionOverrides:{...ee[s.role]}}),className:"flex items-center gap-1 text-xs text-surface-100/50 hover:text-surface-100 transition-colors",children:[e.jsx(ue,{className:"w-3 h-3"}),"Reset to defaults"]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:Object.keys(Se).map(c=>{const{label:M,description:V}=Se[c],Z=s.permissionOverrides[c]===!0,Je=ee[s.role]?.[c]===!0;return e.jsxs("div",{className:`flex items-center justify-between gap-3 px-3 py-2.5 rounded-lg border transition-colors cursor-pointer ${Z?"bg-brand-600/10 border-brand-500/30":"bg-surface-800/30 border-surface-700/30"}`,onClick:()=>{const me={...s.permissionOverrides};Z?delete me[c]:me[c]=!0,g({...s,permissionOverrides:me})},children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"text-xs font-medium text-surface-100 flex items-center gap-1.5",children:[M,Je&&e.jsx("span",{className:"text-[10px] text-surface-100/40 font-normal",children:"(default)"})]}),e.jsx("div",{className:"text-[10px] text-surface-100/40 truncate",children:V})]}),e.jsx("div",{className:`w-8 h-4.5 rounded-full flex-shrink-0 relative transition-colors ${Z?"bg-brand-500":"bg-surface-600"}`,children:e.jsx("div",{className:`absolute top-0.5 w-3.5 h-3.5 rounded-full bg-white shadow transition-transform ${Z?"translate-x-4":"translate-x-0.5"}`})})]},c)})})]})]})}),e.jsx(Ne,{isOpen:N,onClose:()=>b(!1),onConfirm:v,title:"Delete User",message:`Are you sure you want to delete user "${l?.username}"? This action cannot be undone.`,confirmText:"Delete",variant:"danger"}),y&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",role:"dialog","aria-modal":"true","aria-labelledby":"password-reset-dialog-title",onKeyDown:c=>{c.key==="Escape"&&!D&&w(!1)},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>{D||w(!1)},"aria-hidden":"true"}),e.jsxs("div",{className:"relative bg-slate-900 border border-surface-600/50 rounded-2xl shadow-2xl w-full max-w-md p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 rounded-lg bg-amber-500/10 border border-amber-500/20",children:e.jsx(fe,{className:"w-5 h-5 text-amber-400"})}),e.jsxs("div",{children:[e.jsx("h3",{id:"password-reset-dialog-title",className:"text-xl font-bold text-surface-100",children:"Reset Password"}),e.jsx("p",{className:"text-sm text-surface-100/50",children:"Admin action â€” audit logged"})]})]}),e.jsxs("p",{className:"text-surface-100/60 mb-4 text-sm",children:["Set a new password for"," ",e.jsx("strong",{className:"text-surface-100",children:l?.username}),l?.fullName?` (${l.fullName})`:"",". The user will need to use this password on their next login."]}),e.jsxs("div",{className:"mb-1",children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:["New Password ",e.jsx("span",{className:"text-red-400",children:"*"}),e.jsx("span",{className:"text-surface-100/40 font-normal ml-1",children:"(min. 8 characters)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:o?"text":"password",value:T,onChange:c=>{S(c.target.value),u&&p("")},onKeyDown:c=>{c.key==="Enter"&&!D&&R()},placeholder:"Enter new password",autoFocus:!0,className:`w-full px-4 py-2 pr-10 bg-surface-800/40 border rounded-lg text-surface-100 placeholder:text-surface-100/30 focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors ${u?"border-red-500/60":"border-surface-700/50"}`}),e.jsx("button",{type:"button",onClick:()=>x(!o),className:"absolute right-2 top-1/2 -translate-y-1/2 text-surface-100/60 hover:text-surface-100 transition-colors","aria-label":o?"Hide password":"Show password",children:o?e.jsx(Ae,{className:"w-4 h-4"}):e.jsx(ie,{className:"w-4 h-4"})})]}),u&&e.jsx("p",{className:"text-red-400 text-sm mt-1.5",children:u})]}),e.jsxs("div",{className:"flex gap-3 mt-5",children:[e.jsx("button",{onClick:()=>w(!1),disabled:D,className:"flex-1 px-4 py-2 bg-surface-800/40 hover:bg-surface-700/50 border border-surface-700/50 rounded-lg text-surface-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancel"}),e.jsx("button",{onClick:R,disabled:D,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium",children:D?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin w-4 h-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"Resetting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"w-4 h-4"}),"Reset Password"]})})]})]})]})]})},rt=()=>{const[n,r]=m.useState([]),[a,t]=m.useState(!0),[i,h]=m.useState(!1),[N,b]=m.useState(!1),[y,w]=m.useState(!1),[l,C]=m.useState(null),[s,g]=m.useState({name:"",type:"terms-and-conditions",content:"",isDefault:!1}),[j,k]=m.useState(!1),[T,S]=m.useState({}),[o,x]=m.useState("terms-and-conditions"),{user:u}=Y(),p=os(),E=de();m.useEffect(()=>{A()},[]);const A=async()=>{try{t(!0);const v=await p.getByType("terms-and-conditions"),d=await p.getByType("cover-letter"),R=await p.getByType("email"),$=await p.getByType("quote-header"),J=[...v,...d,...R,...$];r(J)}catch(v){console.error("Failed to load templates:",v),P.error("Failed to load templates")}finally{t(!1)}},D=()=>{const v={};return s.name.trim()||(v.name="Template name is required"),(!s.content||typeof s.content=="string"&&!s.content.trim())&&(v.content="Template content is required"),S(v),Object.keys(v).length===0},I=v=>{C(null),g({name:"",type:v,content:v==="terms-and-conditions"?Q():v==="cover-letter"?G():"",isDefault:!1}),S({}),h(!0)},O=v=>{C(v),g({name:v.name,type:v.type,content:v.content,isDefault:v.isDefault}),S({}),h(!0)},L=async v=>{C(null),g({name:`${v.name} (Copy)`,type:v.type,content:v.content,isDefault:!1}),S({}),h(!0)},U=async()=>{if(D()){k(!0);try{if(l){const v={name:s.name,content:s.content,isDefault:s.isDefault};if(s.isDefault){const R=n.filter($=>$.type===l.type&&$.id!==l.id);for(const $ of R)await p.save({...$,isDefault:!1})}const d={...l,...v,updatedAt:new Date().toISOString()};await p.save(d),await E.log({userId:u.id,action:"update",entityType:"template",entityId:l.id,changes:v,oldValues:l,newValues:d})}else{if(s.isDefault){const d=n.filter(R=>R.type===s.type);for(const R of d)await p.save({...R,isDefault:!1})}const v=await p.save({name:s.name,type:s.type,content:s.content,isDefault:s.isDefault});await E.log({userId:u.id,action:"create",entityType:"template",entityId:v,changes:{created:!0},newValues:s})}h(!1),await A()}catch(v){console.error("Failed to save template:",v),P.error("Failed to save template")}finally{k(!1)}}},_=v=>{C(v),b(!0)},F=async()=>{if(l)try{await p.delete(l.id),await E.log({userId:u.id,action:"delete",entityType:"template",entityId:l.id,changes:{deleted:!0},oldValues:l}),b(!1),await A()}catch(v){console.error("Failed to delete template:",v),P.error("Failed to delete template")}},q=v=>{C(v),w(!0)},Q=()=>({sections:[{number:1,title:"Quotation Validity",content:["This quotation is valid for 30 days from the date of issue.","Prices are subject to change without notice after the validity period."]},{number:2,title:"Payment Terms",content:["Payment terms are net 30 days from invoice date.","Late payments may incur interest charges at 2% per month."]}],footer:"All prices exclude VAT unless otherwise stated."}),G=()=>`Dear {customerName},

Thank you for your interest in our products. We are pleased to provide you with quotation {quoteRef}.

This quotation includes all the equipment and services discussed during our recent meeting. Please review the attached specifications and pricing details.

Should you have any questions or require further information, please do not hesitate to contact us.

We look forward to working with you.

Best regards,
{signatoryName}
{signatoryTitle}`,K=n.filter(v=>v.type===o),B=[{key:"name",label:"Template Name",sortable:!0},{key:"type",label:"Type",sortable:!0,render:v=>e.jsx("span",{className:"text-surface-100/80 capitalize",children:v.replace(/-/g," ")})},{key:"isDefault",label:"Default",sortable:!0,render:v=>e.jsx(re,{variant:v?"success":"info",children:v?"Yes":"No"})},{key:"updatedAt",label:"Last Modified",sortable:!0,render:v=>new Date(v).toLocaleString()},{key:"actions",label:"Actions",render:(v,d)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>q(d),className:"p-1 hover:bg-surface-700/50 rounded text-surface-100/60 hover:text-surface-100",title:"Preview",children:e.jsx(ie,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>L(d),className:"p-1 hover:bg-surface-700/50 rounded text-surface-100/60 hover:text-surface-100",title:"Duplicate",children:e.jsx(cs,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>O(d),className:"p-1 hover:bg-surface-700/50 rounded text-surface-100/60 hover:text-surface-100",title:"Edit",children:e.jsx(Be,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>_(d),className:"p-1 hover:bg-red-500/20 rounded text-surface-100/60 hover:text-red-400",title:"Delete",children:e.jsx(ce,{className:"w-4 h-4"})})]})}];return e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-surface-100 mb-1",children:"Template Management"}),e.jsx("p",{className:"text-surface-100/60",children:"Manage document templates for quotes and communications"})]})}),e.jsxs("div",{className:"flex gap-2 mb-6 border-b border-surface-700/50",children:[e.jsx("button",{onClick:()=>x("terms-and-conditions"),className:`px-4 py-2 font-medium transition-colors ${o==="terms-and-conditions"?"text-surface-100 border-b-2 border-teal-500":"text-surface-100/60 hover:text-surface-100"}`,children:"Terms & Conditions"}),e.jsx("button",{onClick:()=>x("cover-letter"),className:`px-4 py-2 font-medium transition-colors ${o==="cover-letter"?"text-surface-100 border-b-2 border-teal-500":"text-surface-100/60 hover:text-surface-100"}`,children:"Cover Letters"}),e.jsx("button",{onClick:()=>x("email"),className:`px-4 py-2 font-medium transition-colors ${o==="email"?"text-surface-100 border-b-2 border-teal-500":"text-surface-100/60 hover:text-surface-100"}`,children:"Email Templates"}),e.jsx("button",{onClick:()=>x("quote-header"),className:`px-4 py-2 font-medium transition-colors ${o==="quote-header"?"text-surface-100 border-b-2 border-teal-500":"text-surface-100/60 hover:text-surface-100"}`,children:"Quote Headers"}),e.jsx("div",{className:"flex-1"}),e.jsxs("button",{onClick:()=>I(o),className:"flex items-center gap-2 px-4 py-2 bg-brand-600 hover:bg-brand-700 text-surface-100 rounded-lg transition-colors",children:[e.jsx(we,{className:"w-4 h-4"}),"Add Template"]})]}),e.jsx(He,{columns:B,data:K,loading:a,emptyMessage:`No ${o.replace(/-/g," ")} templates found`}),e.jsx(qe,{isOpen:i,onClose:()=>h(!1),title:l?"Edit Template":"Add Template",onSave:U,loading:j,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:["Template Name ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("input",{type:"text",value:s.name,onChange:v=>g({...s,name:v.target.value}),className:"w-full px-4 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 placeholder:text-surface-100/30 focus:outline-none focus:ring-2 focus:ring-teal-500",placeholder:"Enter template name"}),T.name&&e.jsx("p",{className:"text-red-400 text-sm mt-1",children:T.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:"Type"}),e.jsxs("select",{value:s.type,onChange:v=>g({...s,type:v.target.value}),disabled:!!l,className:"w-full px-4 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 focus:outline-none focus:ring-2 focus:ring-teal-500 disabled:opacity-50",children:[e.jsx("option",{value:"terms-and-conditions",children:"Terms & Conditions"}),e.jsx("option",{value:"cover-letter",children:"Cover Letter"}),e.jsx("option",{value:"email",children:"Email Template"}),e.jsx("option",{value:"quote-header",children:"Quote Header"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:["Content ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{value:typeof s.content=="string"?s.content:JSON.stringify(s.content,null,2),onChange:v=>{try{const d=JSON.parse(v.target.value);g({...s,content:d})}catch{g({...s,content:v.target.value})}},rows:12,className:"w-full px-4 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 placeholder:text-surface-100/30 focus:outline-none focus:ring-2 focus:ring-teal-500 font-mono text-sm",placeholder:s.type==="terms-and-conditions"?"Enter JSON content or use default structure":"Enter template content (supports placeholders like {customerName}, {quoteRef})"}),T.content&&e.jsx("p",{className:"text-red-400 text-sm mt-1",children:T.content}),e.jsxs("p",{className:"text-surface-100/40 text-xs mt-1",children:["Available placeholders: ","{customerName}",", ","{quoteRef}",", ","{date}",", ","{signatoryName}",", ","{signatoryTitle}"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isDefault",checked:s.isDefault,onChange:v=>g({...s,isDefault:v.target.checked}),className:"w-4 h-4 bg-surface-800/40 border border-surface-700/50 rounded focus:ring-2 focus:ring-teal-500"}),e.jsx("label",{htmlFor:"isDefault",className:"text-sm text-surface-100",children:"Set as default template for this type"})]})]})}),e.jsx(Ne,{isOpen:N,onClose:()=>b(!1),onConfirm:F,title:"Delete Template",message:`Are you sure you want to delete template "${l?.name}"? This action cannot be undone.`,confirmText:"Delete",variant:"danger"}),y&&l&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",role:"dialog","aria-modal":"true","aria-labelledby":"template-preview-modal-title",onKeyDown:v=>v.key==="Escape"&&w(!1),children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>w(!1),"aria-hidden":"true"}),e.jsxs("div",{className:"relative bg-slate-900 border border-surface-600/50 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-surface-700/50",children:[e.jsxs("h2",{id:"template-preview-modal-title",className:"text-2xl font-bold text-surface-100",children:["Template Preview: ",l.name]}),e.jsx("button",{onClick:()=>w(!1),className:"p-2 hover:bg-surface-700/50 rounded-lg text-surface-100/60 hover:text-surface-100 transition-colors",children:"âœ•"})]}),e.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-140px)]",children:e.jsx("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-6",children:e.jsx("pre",{className:"text-surface-100/80 text-sm whitespace-pre-wrap font-mono",children:typeof l.content=="string"?l.content:JSON.stringify(l.content,null,2)})})})]})]})]})},nt=()=>{const[n,r]=m.useState([]),[a,t]=m.useState(!0),[i,h]=m.useState(null),[N,b]=m.useState(!1),[y,w]=m.useState(""),[l,C]=m.useState(""),[s,g]=m.useState(""),[j,k]=m.useState(""),[T,S]=m.useState(""),[o,x]=m.useState(""),[u,p]=m.useState(1),E=20,[A,D]=m.useState([]);m.useEffect(()=>{I(),O()},[]);const I=async()=>{try{t(!0);const d=await f.auditLog.orderBy("timestamp").reverse().toArray();r(d)}catch(d){console.error("Failed to load audit logs:",d),P.error("Failed to load audit logs")}finally{t(!1)}},O=async()=>{try{const d=await f.users.toArray();D(d.map(R=>R.id).filter(R=>R!==void 0))}catch(d){console.error("Failed to load users:",d)}},L=d=>{h(d),b(!0)},U=()=>{const R=_().map(c=>({Timestamp:new Date(c.timestamp).toLocaleString(),User:c.userId,Action:c.action,EntityType:c.entityType,EntityID:c.entityId,Changes:JSON.stringify(c.changes)})),$=X.json_to_sheet(R),J=X.book_new();X.book_append_sheet(J,$,"Audit Log");const W=`audit_log_${new Date().toISOString().split("T")[0]}.xlsx`;vs(J,W)},_=()=>n.filter(d=>{if(y&&d.userId!==y||l&&d.action!==l||s&&d.entityType!==s)return!1;if(j){const R=new Date(d.timestamp),$=new Date(j);if(R<$)return!1}if(T){const R=new Date(d.timestamp),$=new Date(T);if($.setHours(23,59,59,999),R>$)return!1}if(o){const R=o.toLowerCase(),$=d.userId.toLowerCase().includes(R),J=d.entityId.toLowerCase().includes(R),W=JSON.stringify(d.changes).toLowerCase().includes(R);if(!$&&!J&&!W)return!1}return!0}),F=_(),q=Math.ceil(F.length/E),Q=F.slice((u-1)*E,u*E),G=d=>{switch(d){case"create":return"success";case"update":return"info";case"delete":return"danger";case"approve":return"success";case"reject":return"danger";case"submit":return"warning";case"escalate":return"brand";case"return":return"warning";case"comment":return"info";case"edit_review":return"info";case"login":return"info";case"logout":return"info";default:return"info"}},K=(d,R)=>{if(!d&&!R)return null;const $=d?Object.keys(d):[],J=R?Object.keys(R):[],W=Array.from(new Set([...$,...J]));return e.jsx("div",{className:"space-y-2",children:W.map(c=>{const M=d?.[c],V=R?.[c];return JSON.stringify(M)!==JSON.stringify(V)?e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm font-medium text-surface-100/80 mb-2",children:c}),M!==void 0&&e.jsxs("div",{className:"mb-1",children:[e.jsx("span",{className:"text-xs text-red-400 font-medium",children:"Old: "}),e.jsx("span",{className:"text-xs text-surface-100/60",children:typeof M=="object"?JSON.stringify(M):String(M)})]}),V!==void 0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-green-400 font-medium",children:"New: "}),e.jsx("span",{className:"text-xs text-surface-100/60",children:typeof V=="object"?JSON.stringify(V):String(V)})]})]},c):null})})},B=Array.from(new Set(n.map(d=>d.action))),v=Array.from(new Set(n.map(d=>d.entityType)));return a?e.jsx("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:e.jsx("div",{className:"text-center py-8 text-surface-100/60",children:"Loading audit logs..."})}):e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-surface-100 mb-1",children:"Audit Log"}),e.jsx("p",{className:"text-surface-100/60",children:"View system activity and changes"})]}),e.jsxs("button",{onClick:U,className:"flex items-center gap-2 px-4 py-2 bg-surface-800/40 hover:bg-surface-700/50 border border-surface-700/50 rounded-lg text-surface-100 transition-colors",children:[e.jsx(ae,{className:"w-4 h-4"}),"Export to Excel"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-100/80 mb-2",children:"Search"}),e.jsx("input",{type:"text",value:o,onChange:d=>x(d.target.value),placeholder:"Search logs...",className:"w-full px-3 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 placeholder:text-surface-100/30 focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-100/80 mb-2",children:"User"}),e.jsxs("select",{value:y,onChange:d=>w(d.target.value),className:"w-full px-3 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm",children:[e.jsx("option",{value:"",children:"All Users"}),A.map(d=>e.jsx("option",{value:d,children:d},d))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-100/80 mb-2",children:"Action"}),e.jsxs("select",{value:l,onChange:d=>C(d.target.value),className:"w-full px-3 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm",children:[e.jsx("option",{value:"",children:"All Actions"}),B.map(d=>e.jsx("option",{value:d,children:d},d))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-100/80 mb-2",children:"Entity Type"}),e.jsxs("select",{value:s,onChange:d=>g(d.target.value),className:"w-full px-3 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm",children:[e.jsx("option",{value:"",children:"All Types"}),v.map(d=>e.jsx("option",{value:d,children:d},d))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-100/80 mb-2",children:"Date Range"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"date",value:j,onChange:d=>k(d.target.value),className:"flex-1 px-2 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm"}),e.jsx("input",{type:"date",value:T,onChange:d=>S(d.target.value),className:"flex-1 px-2 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm"})]})]})]}),e.jsxs("div",{className:"text-sm text-surface-100/60 mb-4",children:["Showing ",Q.length," of ",F.length," log entries",F.length!==n.length&&` (filtered from ${n.length} total)`]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-surface-700/50",children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-surface-100/80",children:"Timestamp"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-surface-100/80",children:"User"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-surface-100/80",children:"Action"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-surface-100/80",children:"Entity Type"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-surface-100/80",children:"Entity ID"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-surface-100/80",children:"Notes"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-surface-100/80",children:"Actions"})]})}),e.jsx("tbody",{children:Q.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-surface-100/60",children:"No audit logs found"})}):Q.map(d=>e.jsxs("tr",{className:"border-b border-white/5 hover:bg-surface-800/40 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-surface-100",children:new Date(d.timestamp).toLocaleString()}),e.jsxs("td",{className:"px-4 py-3 text-sm text-surface-100/80",children:[e.jsx("div",{children:d.userName||d.userId}),d.userName&&e.jsx("div",{className:"text-xs text-surface-100/40",children:d.userId})]}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx(re,{variant:G(d.action),children:d.action.toUpperCase()})}),e.jsx("td",{className:"px-4 py-3 text-sm text-surface-100/80",children:d.entityType}),e.jsx("td",{className:"px-4 py-3 text-sm text-surface-100/60 font-mono",children:d.entityId.length>20?`${d.entityId.substring(0,20)}...`:d.entityId}),e.jsx("td",{className:"px-4 py-3 text-sm text-surface-100/60 max-w-[200px] truncate",title:d.notes||"",children:d.notes||"â€”"}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("button",{onClick:()=>L(d),className:"p-1 hover:bg-surface-700/50 rounded text-surface-100/60 hover:text-surface-100",title:"View Details",children:e.jsx(ie,{className:"w-4 h-4"})})})]},d.id))})]})}),q>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"text-sm text-surface-100/60",children:["Page ",u," of ",q]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>p(Math.max(1,u-1)),disabled:u===1,className:"px-3 py-1 bg-surface-800/40 hover:bg-surface-700/50 border border-surface-700/50 rounded text-surface-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:"Previous"}),e.jsx("button",{onClick:()=>p(Math.min(q,u+1)),disabled:u===q,className:"px-3 py-1 bg-surface-800/40 hover:bg-surface-700/50 border border-surface-700/50 rounded text-surface-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:"Next"})]})]}),N&&i&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",role:"dialog","aria-modal":"true","aria-labelledby":"audit-details-modal-title",onKeyDown:d=>d.key==="Escape"&&b(!1),children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:()=>b(!1),"aria-hidden":"true"}),e.jsxs("div",{className:"relative bg-slate-900 border border-surface-600/50 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-surface-700/50",children:[e.jsx("h2",{id:"audit-details-modal-title",className:"text-2xl font-bold text-surface-100",children:"Audit Log Details"}),e.jsx("button",{onClick:()=>b(!1),className:"p-2 hover:bg-surface-700/50 rounded-lg text-surface-100/60 hover:text-surface-100 transition-colors",children:"âœ•"})]}),e.jsxs("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-140px)] space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-surface-100/60 mb-1",children:"Timestamp"}),e.jsx("div",{className:"text-surface-100",children:new Date(i.timestamp).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-surface-100/60 mb-1",children:"User"}),e.jsx("div",{className:"text-surface-100",children:i.userName||i.userId}),i.userName&&e.jsx("div",{className:"text-xs text-surface-100/40",children:i.userId})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-surface-100/60 mb-1",children:"Action"}),e.jsx(re,{variant:G(i.action),children:i.action.toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-surface-100/60 mb-1",children:"Entity Type"}),e.jsx("div",{className:"text-surface-100",children:i.entityType})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-sm text-surface-100/60 mb-1",children:"Entity ID"}),e.jsx("div",{className:"text-surface-100 font-mono text-sm break-all",children:i.entityId})]}),i.notes&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-sm text-surface-100/60 mb-1",children:"Notes"}),e.jsx("div",{className:"text-surface-100 text-sm bg-surface-800/40 border border-surface-700/50 rounded-lg p-3",children:i.notes})]})]}),i.changes&&Object.keys(i.changes).length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-surface-100/60 mb-2",children:"Changes Summary"}),e.jsx("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-4",children:e.jsx("pre",{className:"text-xs text-surface-100/80 whitespace-pre-wrap",children:JSON.stringify(i.changes,null,2)})})]}),(i.oldValues||i.newValues)&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-surface-100/60 mb-2",children:"Detailed Changes"}),K(i.oldValues,i.newValues)]}),!i.changes&&!i.oldValues&&!i.newValues&&e.jsx("div",{className:"text-surface-100/60 text-center py-8",children:"No change details available"})]})]})]})]})},lt=()=>{const[n,r]=m.useState(!1),[a,t]=m.useState(!1),[i,h]=m.useState("merge"),[N,b]=m.useState(!1),[y,w]=m.useState(null),[l,C]=m.useState(null),[s,g]=m.useState({type:null,message:""}),j=async()=>{r(!0);try{const S=await f.quotes.toArray(),o=await f.customers.toArray(),x=await f.companies.toArray(),u=await f.contacts.toArray(),p=await f.activities.toArray(),E=await f.templates.toArray(),A=await f.auditLog.toArray(),D=await f.approvalTiers.toArray(),I=await f.commissionTiers.toArray(),O=await f.residualCurves.toArray(),L=await f.configurationMatrices.toArray(),U=await f.settings.toArray(),F=(await f.users.toArray()).map(d=>({...d,passwordHash:"[EXCLUDED]"})),q={version:"1.0.0",timestamp:new Date().toISOString(),tables:{quotes:S,customers:o,companies:x,contacts:u,activities:p,templates:E,auditLog:A,approvalTiers:D,commissionTiers:I,residualCurves:O,configurationMatrices:L,users:F,settings:U}},Q=JSON.stringify(q,null,2),G=new Blob([Q],{type:"application/json"}),K=URL.createObjectURL(G),B=document.createElement("a");B.href=K;const v=new Date().toISOString().replace(/[:.]/g,"-").split("T")[0]+"_"+new Date().toTimeString().split(":").slice(0,2).join("");B.download=`bisedge_backup_${v}.json`,document.body.appendChild(B),B.click(),document.body.removeChild(B),URL.revokeObjectURL(K),g({type:"success",message:"Backup exported successfully"})}catch(S){console.error("Export failed:",S),g({type:"error",message:`Export failed: ${S instanceof Error?S.message:"Unknown error"}`})}finally{r(!1)}},k=async S=>{const o=S.target.files?.[0];if(o)try{const x=await o.text(),u=JSON.parse(x);if(!u.version||!u.timestamp||!u.tables)throw new Error("Invalid backup file structure");const p=["quotes","customers","templates","commissionTiers","residualCurves"];for(const A of p)if(!u.tables[A])throw new Error(`Missing required table: ${A}`);const E={quotes:u.tables.quotes?.length||0,customers:u.tables.customers?.length||0,companies:u.tables.companies?.length||0,contacts:u.tables.contacts?.length||0,activities:u.tables.activities?.length||0,templates:u.tables.templates?.length||0,auditLog:u.tables.auditLog?.length||0,approvalTiers:u.tables.approvalTiers?.length||0,commissionTiers:u.tables.commissionTiers?.length||0,residualCurves:u.tables.residualCurves?.length||0,configurationMatrices:u.tables.configurationMatrices?.length||0,users:u.tables.users?.length||0,settings:u.tables.settings?.length||0};C(u),w(E),b(!0),g({type:"info",message:"Backup file loaded. Review the preview and confirm to import."})}catch(x){console.error("Failed to parse backup file:",x),g({type:"error",message:`Failed to parse backup file: ${x instanceof Error?x.message:"Unknown error"}`}),S.target.value=""}},T=async()=>{if(l){t(!0),b(!1);try{i==="replace"&&(await f.quotes.clear(),await f.customers.clear(),await f.companies.clear(),await f.contacts.clear(),await f.activities.clear(),await f.templates.clear(),await f.auditLog.clear(),await f.approvalTiers.clear(),await f.commissionTiers.clear(),await f.residualCurves.clear(),await f.configurationMatrices.clear(),await f.settings.clear()),l.tables.quotes?.length>0&&await f.quotes.bulkPut(l.tables.quotes),l.tables.customers?.length>0&&await f.customers.bulkPut(l.tables.customers),l.tables.companies?.length>0&&await f.companies.bulkPut(l.tables.companies),l.tables.contacts?.length>0&&await f.contacts.bulkPut(l.tables.contacts),l.tables.activities?.length>0&&await f.activities.bulkPut(l.tables.activities),l.tables.templates?.length>0&&await f.templates.bulkPut(l.tables.templates),l.tables.auditLog?.length>0&&await f.auditLog.bulkPut(l.tables.auditLog),l.tables.approvalTiers?.length>0&&await f.approvalTiers.bulkPut(l.tables.approvalTiers),l.tables.commissionTiers?.length>0&&await f.commissionTiers.bulkPut(l.tables.commissionTiers),l.tables.residualCurves?.length>0&&await f.residualCurves.bulkPut(l.tables.residualCurves),l.tables.configurationMatrices?.length>0&&await f.configurationMatrices.bulkPut(l.tables.configurationMatrices),l.tables.settings?.length>0&&await f.settings.bulkPut(l.tables.settings),g({type:"success",message:`Backup imported successfully in ${i} mode. Please reload the page to see changes.`}),P.success("Backup imported successfully"),C(null),w(null)}catch(S){console.error("Import failed:",S),g({type:"error",message:`Import failed: ${S instanceof Error?S.message:"Unknown error"}`}),P.error("Backup import failed")}finally{t(!1)}}};return e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-surface-100 mb-1",children:"Backup & Restore"}),e.jsx("p",{className:"text-surface-100/60",children:"Export and import database backups"})]}),s.type&&e.jsxs("div",{className:`mb-6 p-4 rounded-lg border flex items-start gap-3 ${s.type==="success"?"bg-green-500/10 border-green-500/30":s.type==="error"?"bg-red-500/10 border-red-500/30":"bg-blue-500/10 border-blue-500/30"}`,children:[s.type==="success"&&e.jsx(le,{className:"w-5 h-5 text-green-400 flex-shrink-0 mt-0.5"}),s.type==="error"&&e.jsx(ye,{className:"w-5 h-5 text-red-400 flex-shrink-0 mt-0.5"}),s.type==="info"&&e.jsx(xe,{className:"w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:`text-sm ${s.type==="success"?"text-green-300":s.type==="error"?"text-red-300":"text-blue-300"}`,children:s.message})}),e.jsx("button",{onClick:()=>g({type:null,message:""}),className:"text-surface-100/60 hover:text-surface-100",children:"âœ•"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-3 bg-teal-500/20 rounded-lg",children:e.jsx(ae,{className:"w-6 h-6 text-brand-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-surface-100",children:"Export Backup"}),e.jsx("p",{className:"text-sm text-surface-100/60",children:"Download all database data"})]})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsx("p",{className:"text-sm text-surface-100/80",children:"Creates a JSON file containing:"}),e.jsxs("ul",{className:"text-sm text-surface-100/60 space-y-1 ml-4",children:[e.jsx("li",{children:"â€¢ All quotes and customer data"}),e.jsx("li",{children:"â€¢ CRM companies, contacts & activities"}),e.jsx("li",{children:"â€¢ Templates and settings"}),e.jsx("li",{children:"â€¢ Catalog (models, batteries)"}),e.jsx("li",{children:"â€¢ Configuration matrices"}),e.jsx("li",{children:"â€¢ Pricing configuration"}),e.jsx("li",{children:"â€¢ Audit logs"}),e.jsx("li",{children:"â€¢ User accounts (passwords excluded)"})]})]}),e.jsxs("button",{onClick:j,disabled:n,className:"w-full flex items-center justify-center gap-2 px-4 py-3 bg-brand-600 hover:bg-brand-700 text-surface-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium",children:[e.jsx(ae,{className:"w-5 h-5"}),n?"Exporting...":"Export Backup"]})]}),e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-3 bg-orange-500/20 rounded-lg",children:e.jsx(be,{className:"w-6 h-6 text-orange-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-surface-100",children:"Import Backup"}),e.jsx("p",{className:"text-sm text-surface-100/60",children:"Restore from backup file"})]})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-surface-100 mb-2",children:"Import Mode"}),e.jsxs("select",{value:i,onChange:S=>h(S.target.value),className:"w-full px-3 py-2 bg-surface-800/40 border border-surface-700/50 rounded-lg text-surface-100 focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm",children:[e.jsx("option",{value:"merge",children:"Merge - Keep existing data, add new"}),e.jsx("option",{value:"replace",children:"Replace - Clear tables, restore from backup"})]})]}),i==="replace"&&e.jsx("div",{className:"p-3 bg-red-500/10 border border-red-500/30 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-xs text-red-300",children:[e.jsx("strong",{children:"Warning:"})," Replace mode will delete all existing data before importing. This action cannot be undone."]})]})})]}),e.jsxs("label",{className:"block w-full",children:[e.jsx("input",{type:"file",accept:".json",onChange:k,className:"hidden",disabled:a}),e.jsxs("div",{className:"w-full flex items-center justify-center gap-2 px-4 py-3 bg-orange-600 hover:bg-orange-700 text-surface-100 rounded-lg transition-colors cursor-pointer font-medium",children:[e.jsx(be,{className:"w-5 h-5"}),"Select Backup File"]})]})]})]}),e.jsx(Ne,{isOpen:N,onClose:()=>{b(!1),C(null),w(null)},onConfirm:T,title:`Confirm ${i==="merge"?"Merge":"Replace"} Import`,message:"",confirmText:a?"Importing...":"Confirm Import",variant:i==="replace"?"danger":"warning",children:y&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-surface-100/80 text-sm",children:["The following data will be imported in ",e.jsx("strong",{children:i})," mode:"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-surface-100/60 mb-1",children:"Quotes"}),e.jsx("div",{className:"text-lg font-bold text-surface-100",children:y.quotes})]}),e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-surface-100/60 mb-1",children:"Customers"}),e.jsx("div",{className:"text-lg font-bold text-surface-100",children:y.customers})]}),e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-surface-100/60 mb-1",children:"Companies (CRM)"}),e.jsx("div",{className:"text-lg font-bold text-surface-100",children:y.companies})]}),e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-surface-100/60 mb-1",children:"Contacts"}),e.jsx("div",{className:"text-lg font-bold text-surface-100",children:y.contacts})]}),e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-surface-100/60 mb-1",children:"Activities"}),e.jsx("div",{className:"text-lg font-bold text-surface-100",children:y.activities})]}),e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-surface-100/60 mb-1",children:"Templates"}),e.jsx("div",{className:"text-lg font-bold text-surface-100",children:y.templates})]}),e.jsxs("div",{className:"bg-surface-800/40 border border-surface-700/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-surface-100/60 mb-1",children:"Audit Logs"}),e.jsx("div",{className:"text-lg font-bold text-surface-100",children:y.auditLog})]})]}),i==="replace"&&e.jsx("div",{className:"p-3 bg-red-500/10 border border-red-500/30 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(xe,{className:"w-4 h-4 text-red-400 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs text-red-300",children:"All existing data will be deleted before import. Make sure you have a current backup!"})]})}),e.jsx("div",{className:"p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg",children:e.jsxs("p",{className:"text-xs text-blue-300",children:[e.jsx("strong",{children:"Note:"})," User passwords are excluded from backups for security. Users from backup will need password resets."]})})]})})]})};function it(){const{user:n}=_e(),[r,a]=m.useState([]),[t,i]=m.useState(!0),[h,N]=m.useState({pending:0,approvedToday:0,rejectedToday:0});m.useEffect(()=>{n&&b()},[n]);const b=async()=>{if(n){i(!0);try{const y=he(),w=await y.listQuotes({page:1,pageSize:100,sortBy:"createdAt",sortOrder:"asc"},{status:"pending-approval"}),l=await y.listQuotes({page:1,pageSize:100,sortBy:"createdAt",sortOrder:"asc"},{status:"in-review"}),s=[...w.items,...l.items].filter(j=>n.role==="system_admin"?!0:j.currentAssigneeId===n.id),g=await Promise.all(s.map(async j=>{let k=[];try{k=typeof j.approvalChain=="string"?JSON.parse(j.approvalChain):j.approvalChain||[]}catch{k=[]}let T="Unknown";if(j.submittedBy)try{const S=await y.getUser(j.submittedBy);S&&(T=S.fullName||S.full_name||"Unknown")}catch{}return{id:j.id,quoteRef:j.quoteRef||j.quote_ref||"",clientName:j.clientName||j.client_name||"",contactName:j.contactName||j.contact_name||"",status:j.status,currentAssigneeId:j.currentAssigneeId||j.current_assignee_id||null,currentAssigneeRole:j.currentAssigneeRole||j.current_assignee_role||null,approvalChain:k,submittedBy:j.submittedBy||j.submitted_by||null,submittedAt:j.submittedAt||j.submitted_at||null,createdAt:j.createdAt||j.created_at||"",submitterName:T}}));a(g);try{const k=await de().getRecent(200),T=new Date;T.setHours(0,0,0,0);const S=T.getTime(),o=k.filter(u=>u.action==="approve"&&new Date(u.timestamp).getTime()>=S).length,x=k.filter(u=>u.action==="reject"&&new Date(u.timestamp).getTime()>=S).length;N({pending:g.length,approvedToday:o,rejectedToday:x})}catch{N({pending:g.length,approvedToday:0,rejectedToday:0})}}catch(y){console.error("Error loading pending approvals:",y),P.error("Failed to load approvals")}finally{i(!1)}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold text-surface-100 mb-2",children:"Approval Queue"}),e.jsx("p",{className:"text-surface-100/60",children:"Quotes assigned to you for review and approval"})]}),e.jsxs("button",{onClick:b,disabled:t,className:"flex items-center gap-2 px-4 py-2 bg-brand-600 hover:bg-brand-700 text-surface-100 rounded-lg transition-colors disabled:opacity-50",children:[e.jsx(Ns,{className:`w-4 h-4 ${t?"animate-spin":""}`}),"Refresh"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-amber-500/20 rounded-2xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Ve,{className:"w-8 h-8 text-amber-400"}),e.jsx("span",{className:"text-3xl font-bold text-amber-400",children:h.pending})]}),e.jsx("p",{className:"text-sm text-surface-100/60 mt-2",children:"Pending Approval"})]}),e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-green-500/20 rounded-2xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(le,{className:"w-8 h-8 text-green-400"}),e.jsx("span",{className:"text-3xl font-bold text-green-400",children:h.approvedToday})]}),e.jsx("p",{className:"text-sm text-surface-100/60 mt-2",children:"Approved Today"})]}),e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-red-500/20 rounded-2xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ye,{className:"w-8 h-8 text-red-400"}),e.jsx("span",{className:"text-3xl font-bold text-red-400",children:h.rejectedToday})]}),e.jsx("p",{className:"text-sm text-surface-100/60 mt-2",children:"Rejected Today"})]})]}),t&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ds,{className:"w-8 h-8 animate-spin text-brand-500"})}),!t&&r.length===0&&e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-12 text-center",children:[e.jsx(le,{className:"w-12 h-12 text-green-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-surface-100 mb-2",children:"All Caught Up!"}),e.jsx("p",{className:"text-surface-100/60",children:"No quotes pending your approval"})]}),!t&&r.map(y=>e.jsx(ot,{quote:y,onRefresh:b},y.id))]})}function ot({quote:n,onRefresh:r}){const{user:a}=_e(),[t,i]=m.useState(null),[h,N]=m.useState(!1),[b,y]=m.useState([]),w=n.submittedAt?Math.floor((Date.now()-new Date(n.submittedAt).getTime())/(1e3*60*60)):0,l=a?us({status:n.status,currentAssigneeId:n.currentAssigneeId,createdBy:n.createdBy||n.submittedBy},a.id,a.role,a.permissionOverrides).filter(k=>k!=="submit"&&k!=="edit"):[];m.useEffect(()=>{!t||t==="approve"||t==="reject"||t==="comment"||C()},[t]);const C=async()=>{const k=he(),T=[],S=t==="return"?Te(a.role):Ee(a.role);for(const o of S){const x=await k.getUsersByRole(o);T.push(...x.map(u=>({id:u.id,fullName:u.fullName,role:u.role})))}y(T)},s=async k=>{if(!(!a||!t)){N(!0);try{const T=he(),S=await T.loadQuote(n.id);if(!S)throw new Error("Quote not found");const o={id:a.id,name:a.fullName,role:a.role},x=t==="approve"||t==="reject"||t==="comment"?o:{id:k.targetUserId,name:k.targetUserName,role:k.targetRole},p=ps(t==="approve"?"approved":t==="reject"?"rejected":t==="escalate"?"escalated":t==="return"?"returned":"commented",o,x,k.notes),E=hs(t,S.status),A=t==="comment",D={...S,status:E,currentAssigneeId:A?S.currentAssigneeId:x.id,currentAssigneeRole:A?S.currentAssigneeRole:x.role,approvalChain:[...S.approvalChain||[],p],updatedAt:new Date,...t==="approve"?{approvedBy:a.id,approvedAt:new Date}:{}};await T.saveQuote(D),await de().log({userId:a.id,userName:a.fullName,action:t,entityType:"quote",entityId:n.id,notes:k.notes,changes:{status:E}});const I=t==="approve"?"approved":t==="reject"?"rejected":t;P.success(`Quote ${I}!`),i(null),r()}catch(T){console.error("Action failed:",T),P.error("Action failed")}finally{N(!1)}}},g=t==="escalate"||t==="return",j=t==="return"?Te(a?.role).map(k=>({value:k,label:te[k]})):Ee(a?.role).map(k=>({value:k,label:te[k]}));return e.jsxs("div",{className:"bg-surface-700/50 backdrop-blur-xl border border-surface-600/50 rounded-2xl p-6 hover:border-surface-500/50 transition-colors",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"w-4 h-4 text-brand-400"}),e.jsxs("h3",{className:"text-lg font-semibold text-surface-100",children:["Quote ",n.quoteRef]})]}),e.jsx("p",{className:"text-surface-100/60 text-sm mt-1",children:n.clientName})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:`inline-flex px-3 py-1 rounded-full text-xs font-medium ${n.status==="pending-approval"?"bg-amber-500/10 border border-amber-500/30 text-amber-400":"bg-blue-500/10 border border-blue-500/30 text-blue-400"}`,children:n.status.replace(/-/g," ")}),e.jsxs("p",{className:"text-xs text-surface-100/40 mt-1",children:[e.jsx(Ve,{className:"w-3 h-3 inline mr-1"}),w<1?"Just now":`${w}h ago`]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-surface-100/40 text-xs",children:"Submitted By"}),e.jsxs("div",{className:"text-surface-200 font-medium flex items-center gap-1 mt-0.5",children:[e.jsx(Pe,{className:"w-3 h-3"}),n.submitterName||"Unknown"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-surface-100/40 text-xs",children:"Contact"}),e.jsx("div",{className:"text-surface-200 mt-0.5",children:n.contactName||"â€”"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-surface-100/40 text-xs",children:"Assigned Role"}),e.jsx("div",{className:"text-brand-400 font-medium mt-0.5",children:te[n.currentAssigneeRole]||n.currentAssigneeRole||"â€”"})]})]}),n.approvalChain.length>0&&e.jsx("div",{className:"mb-4",children:e.jsx(ms,{chain:n.approvalChain,compact:!0})}),l.length>0&&e.jsxs("div",{className:"flex gap-2 pt-3 border-t border-surface-600/30",children:[l.includes("approve")&&e.jsxs("button",{onClick:()=>i("approve"),disabled:h,className:"flex-1 flex items-center justify-center gap-1.5 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-surface-100 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:[e.jsx(le,{className:"w-4 h-4"}),"Approve"]}),l.includes("reject")&&e.jsxs("button",{onClick:()=>i("reject"),disabled:h,className:"flex-1 flex items-center justify-center gap-1.5 px-4 py-2 bg-red-600 hover:bg-red-700 text-surface-100 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:[e.jsx(ye,{className:"w-4 h-4"}),"Reject"]}),l.includes("escalate")&&e.jsx("button",{onClick:()=>i("escalate"),disabled:h,className:"px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-surface-100 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:"Escalate"}),l.includes("return")&&e.jsx("button",{onClick:()=>i("return"),disabled:h,className:"px-4 py-2 bg-amber-600 hover:bg-amber-700 text-surface-100 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:"Return"}),l.includes("comment")&&e.jsx("button",{onClick:()=>i("comment"),disabled:h,className:"px-4 py-2 bg-surface-600 hover:bg-surface-500 text-surface-100 rounded-lg text-sm font-medium transition-colors disabled:opacity-50",children:"Comment"})]}),t&&e.jsx(xs,{isOpen:!!t,onClose:()=>i(null),action:t,title:fs(t),showTargetPicker:g,targetRoles:j,users:b,onConfirm:s,isProcessing:h})]})}class ct extends m.Component{constructor(r){super(r),this.state={hasError:!1,error:null}}static getDerivedStateFromError(r){return{hasError:!0,error:r}}componentDidCatch(r,a){console.error("Admin page error:",r,a)}render(){return this.state.hasError?e.jsx("div",{className:"bg-red-500/10 border border-red-500/30 rounded-2xl p-8 m-4",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx(ne,{className:"w-8 h-8 text-red-400 flex-shrink-0 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-red-400 mb-2",children:"Something went wrong"}),e.jsx("p",{className:"text-surface-400 mb-4",children:"An error occurred while rendering this admin page."}),this.state.error&&e.jsx("pre",{className:"text-red-300 text-sm bg-red-500/5 border border-red-500/20 rounded-lg p-4 mb-4 overflow-x-auto",children:this.state.error.message}),e.jsxs("button",{onClick:()=>this.setState({hasError:!1,error:null}),className:"flex items-center gap-2 px-4 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-200 transition-colors",children:[e.jsx(ue,{className:"w-4 h-4"}),"Try Again"]})]})]})}):this.props.children}}const vt=()=>{const[n,r]=m.useState(!1);return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-surface-900 via-surface-800 to-surface-900",children:[e.jsx(Ps,{}),e.jsxs("div",{className:"flex min-h-[calc(100vh-73px)]",children:[e.jsx("button",{className:"fixed top-4 left-4 z-50 p-2 rounded-lg bg-surface-800/80 backdrop-blur-sm border border-surface-600/50 text-surface-100 lg:hidden",onClick:()=>r(!0),"aria-label":"Open navigation",children:e.jsx(Ds,{className:"w-5 h-5"})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(Re,{})}),e.jsx(Qe,{children:n&&e.jsxs(e.Fragment,{children:[e.jsx(Ce.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 z-40 bg-black/60 backdrop-blur-sm lg:hidden",onClick:()=>r(!1)},"backdrop"),e.jsx(Ce.div,{initial:{x:"-100%"},animate:{x:0},exit:{x:"-100%"},transition:{type:"spring",stiffness:300,damping:30},className:"fixed top-0 left-0 z-50 h-full lg:hidden",children:e.jsxs("div",{className:"relative h-full",children:[e.jsx("button",{className:"absolute top-4 right-4 p-1.5 rounded-lg text-surface-400 hover:text-surface-100 hover:bg-surface-700/50 transition-colors",onClick:()=>r(!1),"aria-label":"Close navigation",children:e.jsx(Ue,{className:"w-5 h-5"})}),e.jsx(Re,{})]})},"drawer")]})}),e.jsx("main",{className:"flex-1 p-8 overflow-auto",children:e.jsx(ct,{children:e.jsxs(We,{children:[e.jsx(z,{index:!0,element:e.jsx(ke,{to:"pricing",replace:!0})}),e.jsx(z,{path:"pricing",element:e.jsx(Gs,{})}),e.jsx(z,{path:"configuration",element:e.jsx(tt,{})}),e.jsx(z,{path:"approvals",element:e.jsx(it,{})}),e.jsx(z,{path:"users",element:e.jsx(at,{})}),e.jsx(z,{path:"templates",element:e.jsx(rt,{})}),e.jsx(z,{path:"audit",element:e.jsx(nt,{})}),e.jsx(z,{path:"backup",element:e.jsx(lt,{})}),e.jsx(z,{path:"*",element:e.jsx(ke,{to:"pricing",replace:!0})})]})})})]})]})};export{vt as default};
